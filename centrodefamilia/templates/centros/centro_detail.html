{% extends "includes/main.html" %}
{% load static %}
{% block title %}{{ centro.nombre }}{% endblock %}
{% block content %}
    <link rel="stylesheet" href="{% static 'custom/css/centro_detail.css' %}" />
    <!-- 1) HEADER -->
    <div class="card mb-4 page-header">
        <div class="card-body">
            <div class="header-bar"></div>
            <h1 class="header-title mb-0">
                {{ centro.nombre|capfirst }}
                <span class="separator">|</span>
                <span id="tipo-badge" class="badge header-badge">{{ centro.get_tipo_display|capfirst }}</span>
            </h1>
        </div>
    </div>
    <!-- 2) BOTONES DE ACCIÓN -->
    <div class="mt-4 mb-4 d-flex justify-content-end">
        <div class="btn-group btn-group-sm" role="group" aria-label="Acciones">
            <a href="{% url 'centro_update' centro.id %}"
               class="btn btn-outline-primary">Editar</a>
            <a href="{% url 'centro_list' %}" class="btn btn-outline-secondary">Volver</a>
            <a href="{% url 'actividadcentro_create' centro_id=centro.id %}"
               class="btn btn-outline-success">Agregar Actividad</a>
            {% if centro.tipo == 'faro' %}
                <a href="{% url 'centro_create' %}?faro={{ centro.id }}"
                   class="btn btn-outline-info">Agregar Centro Adherido</a>
            {% endif %}
        </div>
    </div>
    <!-- Acordion -->
    <div class="container">
        <div class="accordion-horizontal shadow shadow-sm mb-3">
            <!-- panel 1 -->
            <div class="accordion-panel open" onclick="toggleAccordion(this)">
                <div class="accordion-header bg-header-1 fs-6">Ubicación</div>
                <div class="accordion-content mx-1">
                    <div class="row">
                        <div class="col-5 d-flex align-items-center justify-content-center">
                            <div class="map-container" id="mapa-iframe">
                                {% if centro.calle and centro.numero and centro.localidad and centro.municipio and centro.provincia %}
                                    <iframe src="https://maps.google.com/maps?q={{ centro.calle|urlencode }}+{{ centro.numero }},+{{ centro.localidad.nombre|urlencode }},+{{ centro.municipio.nombre|urlencode }},+{{ centro.provincia.nombre|urlencode }}&output=embed"
                                            width="100%"
                                            height="100%"
                                            frameborder="0"
                                            style="border:0;
                                                   border-radius:8px"
                                            allowfullscreen>
                                    </iframe>
                                {% else %}
                                    <div class="text-muted">Sin mapa disponible</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-7">
                            <div class="details-container" id="detalles-ubicacion">
                                <h5>Ubicación</h5>
                                <hr />
                                <ul class="no-bullets">
                                    <li>
                                        <i class="fas fa-road me-2 text-info"></i>Calle: {{ centro.calle }} {{ centro.numero }}
                                    </li>
                                    <li>
                                        <i class="fas fa-globe-americas me-2 text-info"></i>{{ centro.localidad }}, {{ centro.provincia }}
                                    </li>
                                    <li>
                                        <i class="fas fa-map-pin me-2 text-info"></i>Domicilio de Actividades: {{ centro.domicilio_actividad }}
                                    </li>
                                    <li>
                                        <i class="fas fa-phone me-2 text-info"></i>Teléfono: {{ centro.telefono }}
                                    </li>
                                    <li>
                                        <i class="fas fa-mobile-alt me-2 text-info"></i>Celular: {{ centro.celular }}
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- panel 2 -->
            <div class="accordion-panel" onclick="toggleAccordion(this)">
                <div class="accordion-header bg-header-2 fs-6">Información Basica</div>
                <div class="accordion-content mx-1">
                    <div class="row">
                        <h5>Información Básica</h5>
                        <hr />
                        <div class="row g-3">
                            <div class="col-sm-6 d-flex">
                                <i class="fas fa-user me-2 text-info mt-1"></i>
                                <div>
                                    <div class="fw-bold">Nombre</div>
                                    <div>{{ centro.nombre }}</div>
                                </div>
                            </div>
                            <div class="col-sm-6 d-flex">
                                <i class="fas fa-layer-group me-2 text-info mt-1"></i>
                                <div>
                                    <div class="fw-bold">Tipo</div>
                                    <div>{{ centro.get_tipo_display }}</div>
                                </div>
                            </div>
                            <div class="col-sm-6 d-flex">
                                <i class="fas fa-barcode me-2 text-info mt-1"></i>
                                <div>
                                    <div class="fw-bold">Código</div>
                                    <div>{{ centro.codigo }}</div>
                                </div>
                            </div>
                            <div class="col-sm-6 d-flex">
                                <i class="fas fa-flag me-2 text-info mt-1"></i>
                                <div>
                                    <div class="fw-bold">Provincia</div>
                                    <div>{{ centro.provincia }}</div>
                                </div>
                            </div>
                            <div class="col-sm-6 d-flex">
                                <i class="fas fa-city me-2 text-info mt-1"></i>
                                <div>
                                    <div class="fw-bold">Municipio</div>
                                    <div>{{ centro.municipio }}</div>
                                </div>
                            </div>
                            <div class="col-sm-6 d-flex">
                                <i class="fas fa-map-marked-alt me-2 text-info mt-1"></i>
                                <div>
                                    <div class="fw-bold">Localidad</div>
                                    <div>{{ centro.localidad }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- panel 3 -->
            <div class="accordion-panel" onclick="toggleAccordion(this)">
                <div class="accordion-header bg-header-3 fs-6">Datos</div>
                <div class="accordion-content mx-1">
                    <div class="row">
                        <h5>Datos</h5>
                        <hr />
                        <div class="row g-3">
                            <div class="col-sm-6 d-flex">
                                <i class="fas fa-envelope me-2 text-info mt-1"></i>
                                <div>
                                    <div class="fw-bold">Correo electrónico</div>
                                    <div>{{ centro.correo }}</div>
                                </div>
                            </div>
                            <div class="col-sm-6 d-flex">
                                <i class="fas fa-globe me-2 text-info mt-1"></i>
                                <div>
                                    <div class="fw-bold">Sitio web</div>
                                    <div>{{ centro.sitio_web }}</div>
                                </div>
                            </div>
                            <div class="col-sm-6 d-flex">
                                <i class="fas fa-share-alt me-2 text-info mt-1"></i>
                                <div>
                                    <div class="fw-bold">Redes sociales</div>
                                    <div>{{ centro.link_redes }}</div>
                                </div>
                            </div>
                            <div class="col-sm-6 d-flex">
                                <i class="fas fa-building me-2 text-info mt-1"></i>
                                <div>
                                    <div class="fw-bold">Organización</div>
                                    <div>{{ centro.organizacion_asociada }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- panel 4 -->
            <div class="accordion-panel" onclick="toggleAccordion(this)">
                <div class="accordion-header bg-header-4 fs-6">Asistencia</div>
                <div class="accordion-content mx-1">
                    <div class="row">
                        <h5>Asistencia</h5>
                        <hr />
                        {% with ultimo=archivos_cabal_centro|first %}
                            {% if ultimo %}
                                <p>
                                    <strong>Último informe CABAL:</strong> {{ ultimo.fecha_subida|date:"d/m/Y H:i" }}
                                </p>
                                <p>
                                    <strong>Subido por:</strong> {{ ultimo.usuario.get_full_name|default:ultimo.usuario.username }}
                                </p>
                            {% else %}
                                <p>No hay informes CABAL vinculados aún.</p>
                            {% endif %}
                        {% endwith %}
                    </div>
                </div>
            </div>
            <!-- panel 5 -->
            <div class="accordion-panel" onclick="toggleAccordion(this)">
                <div class="accordion-header bg-header-5 fs-6">Referente</div>
                <div class="accordion-content mx-1">
                    <div class="row">
                        <h5>Referente</h5>
                        <hr />
                        <div class="row g-3">
                            <div class="col-sm-6 d-flex">
                                <i class="fas fa-user-tie me-2 text-info mt-1"></i>
                                <div>
                                    <div class="fw-bold">Responsable</div>
                                    <div>{{ centro.nombre_referente }} {{ centro.apellido_referente }}</div>
                                </div>
                            </div>
                            <div class="col-sm-6 d-flex">
                                <i class="fas fa-phone me-2 text-info mt-1"></i>
                                <div>
                                    <div class="fw-bold">Teléfono</div>
                                    <div>{{ centro.telefono_referente }}</div>
                                </div>
                            </div>
                            <div class="col-sm-6 d-flex">
                                <i class="fas fa-envelope me-2 text-info mt-1"></i>
                                <div>
                                    <div class="fw-bold">Correo</div>
                                    <div>{{ centro.correo_referente }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- /Acordion -->
    <!-- 4) MÉTRICAS RÁPIDAS -->
    <div class="d-flex gap-3 mb-4">
        {% if centro.tipo == 'faro' %}
            <div class="flex-fill card bg-navy text-white text-center p-3">
                <i class="fas fa-network-wired fa-2x mb-2 text-warning"></i>
                <div>Centros Adheridos</div>
                <strong>{{ metricas.centros_faro }}</strong>
            </div>
        {% endif %}
        {% if centro.tipo == 'adherido' %}
            <div class="flex-fill card bg-navy text-white text-center p-3">
                <i class="fas fa-dollar-sign fa-2x mb-2 text-success"></i>
                <div>Monto Recaudado</div>
                <strong>${{ total_recaudado }}</strong>
            </div>
        {% endif %}
        <div class="flex-fill card bg-navy text-white text-center p-3">
            <i class="fas fa-layer-group fa-2x mb-2 text-info"></i>
            <div>Categorías</div>
            <strong>{{ metricas.categorias }}</strong>
        </div>
        <div class="flex-fill card bg-navy text-white text-center p-3">
            <i class="fas fa-tasks fa-2x mb-2 text-success"></i>
            <div>Actividades</div>
            <strong>{{ metricas.actividades }}</strong>
        </div>
        <div class="flex-fill card bg-navy text-white text-center p-3">
            <i class="fas fa-user-check fa-2x mb-2 text-primary"></i>
            <div>Inscriptos</div>
            <strong>{{ metricas.inscriptos }}</strong>
        </div>
    </div>
    <!-- 5) CENTROS ADHERIDOS -->
    {% if centro.tipo == 'faro' %}
        <div class="card bg-dark text-white mb-4">
            <div class="card-header bg-secondary d-flex align-items-center">
                Centros Adheridos
                <input id="filterCentros"
                       class="form-control form-control-sm bg-dark text-white border-secondary ms-auto"
                       style="width:180px"
                       placeholder="Buscar centro…" />
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table id="tablaCentros" class="table table-dark table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Tipo</th>
                                <th>Activo</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for adh in centros_adheridos_paginados %}
                                <tr>
                                    <td>
                                        <a class="text-info">{{ adh.nombre }}</a>
                                    </td>
                                    <td>{{ adh.get_tipo_display }}</td>
                                    <td>
                                        {% if adh.activo %}
                                            <span class="badge bg-success">Sí</span>
                                        {% else %}
                                            <span class="badge bg-danger">No</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if not centros_adheridos_paginados %}
                    <div class="p-3 text-center text-muted">No hay centros adheridos.</div>
                {% endif %}
            </div>
            {% if centros_adheridos_paginados.has_other_pages %}
                <div class="card-footer bg-dark text-center">
                    <ul class="pagination justify-content-center mb-0">
                        {% if centros_adheridos_paginados.has_previous %}
                            <li class="page-item">
                                <a class="page-link bg-secondary text-white"
                                   href="?page={{ centros_adheridos_paginados.previous_page_number }}">Anterior</a>
                            </li>
                        {% endif %}
                        {% for i in centros_adheridos_paginados.paginator.page_range %}
                            <li class="page-item {% if centros_adheridos_paginados.number == i %}active{% endif %}">
                                <a class="page-link bg-secondary text-white" href="?page={{ i }}">{{ i }}</a>
                            </li>
                        {% endfor %}
                        {% if centros_adheridos_paginados.has_next %}
                            <li class="page-item">
                                <a class="page-link bg-secondary text-white"
                                   href="?page={{ centros_adheridos_paginados.next_page_number }}">Siguiente</a>
                            </li>
                        {% endif %}
                    </ul>
                </div>
            {% endif %}
        </div>
    {% endif %}
    <!-- 6) NÓMINA ASISTENTES & INFORMES CABAL -->
    <div class="row gx-3 mb-4">
        <div class="col-md-3">
            <div class="card bg-dark text-white h-100">
                <div class="card-header bg-secondary">Nómina Asistentes</div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center bg-navy text-white">
                        <div>
                            <i class="fas fa-users fa-lg me-2"></i>Asistentes
                        </div>
                        <span class="badge rounded-pill bg-warning">{{ asistentes.total }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center bg-navy text-white">
                        <div>
                            <i class="fas fa-male fa-lg me-2"></i>Hombres
                        </div>
                        <span class="badge rounded-pill bg-info">{{ asistentes.hombres }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center bg-navy text-white">
                        <div>
                            <i class="fas fa-female fa-lg me-2"></i>Mujeres
                        </div>
                        <span class="badge rounded-pill bg-danger">{{ asistentes.mujeres }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center bg-navy text-white">
                        <div>
                            <i class="fas fa-list fa-lg me-2"></i>Lista de espera
                        </div>
                        <span class="badge rounded-pill bg-danger">{{ asistentes.espera }}</span>
                    </li>
                </ul>
            </div>
        </div>
        <!-- Informes CABAL por centro -->
        <div class="col-md-9">
            <div id="expedientes-container" class="card bg-dark text-white mb-4">
                <div class="card-header bg-secondary">Informes CABAL</div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>Archivo</th>
                                    <th>Fecha de carga</th>
                                    <th class="text-end">Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for a in archivos_cabal_centro %}
                                    <tr>
                                        <td>
                                            <a href="{% url 'informecabal_archivo_centro_detail' centro.id a.id %}"
                                               class="text-info text-decoration-none">{{ a.nombre_original }}</a>
                                        </td>
                                        <td>{{ a.fecha_subida|date:"d/m/Y H:i" }}</td>
                                        <td class="text-end">
                                            <a href="{% url 'informecabal_archivo_centro_detail' centro.id a.id %}"
                                               class="btn btn-sm btn-outline-info">Ver registros</a>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="3" class="text-center text-muted py-3">No hay informes CABAL con registros vinculados a este centro.</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- (Si querés paginar archivos_cabal_centro, armamos paginado en la vista y lo renderizamos acá) -->
            </div>
        </div>
    </div>
    <!-- 7) ACTIVIDADES CONFIGURADAS -->
    <div id="actividades-curso-container" class="row gx-3 mb-4">
        <div class="col-md-6">
            <div class="card bg-dark text-white actividades-card h-100">
                <div class="card-header bg-secondary d-flex align-items-center">
                    Actividades en curso
                    <input id="searchCurso"
                           value="{{ request.GET.search_actividades_curso }}"
                           class="form-control form-control-sm bg-dark text-white border-secondary ms-auto"
                           style="width:180px"
                           placeholder="Buscar actividad…" />
                </div>
                <div class="card-body p-3">
                    <div class="table-responsive">
                        <table class="table table-dark table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>Actividad</th>
                                    <th>Categoría</th>
                                    <th>Dias</th>
                                    <th>Horario</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for act in actividades %}
                                    <tr>
                                        <td>
                                            <a href="{% url 'actividadcentro_detail' centro_id=centro.id pk=act.id %}"
                                               class="text-info text-decoration-none">{{ act.actividad.nombre }}</a>
                                        </td>
                                        <td>{{ act.actividad.categoria.nombre }}</td>
                                        <td>
                                            {% for dia in act.dias.all %}
                                                {{ dia.nombre }}
                                                {% if not forloop.last %},{% endif %}
                                            {% empty %}&mdash;
                                            {% endfor %}
                                        </td>
                                        <td>{{ act.horariosdesde }} - {{ act.horarioshasta }}</td>
                                        <td>{{ act.get_estado_display }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-dark text-white observaciones-card h-100">
                <div class="card-header bg-secondary">Observaciones</div>
                <div class="card-body">
                    {% if observaciones %}
                        <ul class="list-unstyled mb-0">
                            {% for obs in observaciones %}
                                <li class="mb-3">
                                    <small class="text-muted">{{ obs.fecha }} – {{ obs.autor }}</small>
                                    <p class="mb-0">{{ obs.texto }}</p>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>No hay observaciones registradas.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <!-- 8) TODAS LAS ACTIVIDADES -->
    <div id="actividades-todas-container" class="card bg-dark text-white mb-4">
        <div class="card-header bg-secondary d-flex align-items-center">
            Todas las Actividades
            <input id="searchActividades"
                   value="{{ request.GET.search_actividades }}"
                   class="form-control form-control-sm bg-dark text-white border-secondary ms-auto"
                   style="width:180px"
                   placeholder="Buscar actividad…" />
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table id="tablaActividades" class="table table-dark table-striped mb-0">
                    <thead>
                        <tr>
                            <th>Centro</th>
                            <th>Actividad</th>
                            <th>Categoría</th>
                            <th>Estado</th>
                            <th class="text-end">Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ac in actividades_paginados %}
                            <tr>
                                <td>{{ ac.centro.nombre }}</td>
                                <td>{{ ac.actividad.nombre }}</td>
                                <td>{{ ac.actividad.categoria.nombre }}</td>
                                <td>{{ ac.get_estado_display }}</td>
                                <td class="text-end">
                                    <button class="btn btn-outline-info btn-sm"
                                            data-bs-toggle="modal"
                                            data-bs-target="#modalAct{{ ac.id }}">Detalles</button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if not actividades_paginados %}<div class="p-3 text-center text-muted">No hay actividades.</div>{% endif %}
        </div>
        {% if actividades_paginados.has_other_pages %}
            <div class="card-footer bg-dark text-center">
                <ul class="pagination justify-content-center mb-0">
                    {% if actividades_paginados.has_previous %}
                        <li class="page-item">
                            <a class="page-link bg-secondary text-white"
                               href="?page_act={{ actividades_paginados.previous_page_number }}&search_actividades={{ request.GET.search_actividades }}">Anterior</a>
                        </li>
                    {% endif %}
                    {% for i in actividades_paginados.paginator.page_range %}
                        <li class="page-item {% if actividades_paginados.number == i %}active{% endif %}">
                            <a class="page-link bg-secondary text-white"
                               href="?page_act={{ i }}&search_actividades={{ request.GET.search_actividades }}">{{ i }}</a>
                        </li>
                    {% endfor %}
                    {% if actividades_paginados.has_next %}
                        <li class="page-item">
                            <a class="page-link bg-secondary text-white"
                               href="?page_act={{ actividades_paginados.next_page_number }}&search_actividades={{ request.GET.search_actividades }}">Siguiente</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        {% endif %}
    </div>
    <!-- 9) MODALES DE DETALLES -->
    {% for ac in actividades_paginados %}
        <div class="modal fade"
             id="modalAct{{ ac.id }}"
             tabindex="-1"
             aria-labelledby="modalActLabel{{ ac.id }}"
             aria-hidden="true">
            <div class="modal-dialog modal-dialog-scrollable modal-lg">
                <div class="modal-content bg-dark text-white">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalActLabel{{ ac.id }}">{{ ac.actividad.nombre }} – {{ ac.centro.nombre }}</h5>
                        <button type="button"
                                class="btn-close btn-close-white"
                                data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <dl class="row text-white">
                            <dt class="col-5">Cupo Total</dt>
                            <dd class="col-7">
                                {{ ac.cantidad_personas }}
                            </dd>
                            <dt class="col-5">Días</dt>
                            <dd class="col-7">
                                {% for d in ac.dias.all %}
                                    <span class="badge bg-secondary">{{ d.nombre }}</span>
                                    {% empty %}<span class="text-muted">No especificado</span>
                                {% endfor %}
                            </dd>
                            <dt class="col-5">Horario desde</dt>
                            <dd class="col-7">
                                {{ ac.horariosdesde }}
                            </dd>
                            <dt class="col-5">Horario hasta</dt>
                            <dd class="col-7">
                                {{ ac.horarioshasta }}
                            </dd>
                            <dt class="col-5">Precio</dt>
                            <dd class="col-7">
                                {% if ac.precio %}
                                    ${{ ac.precio }}
                                {% else %}
                                    <span class="text-muted">Gratuita</span>
                                {% endif %}
                            </dd>
                            <dt class="col-5">Estado</dt>
                            <dd class="col-7">
                                {{ ac.get_estado_display }}
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
    <!-- 10) GAUGES POR CATEGORÍAS -->
    <div class="row gx-3 mb-4">
        {% for cat in cat_metrics %}
            <div class="col-6 col-md-3 text-center">
                <div id="gauge-container-{{ forloop.counter }}"
                     style="width:150px;
                            height:100px;
                            margin:0 auto"></div>
                <div class="mt-2 text-white fw-bold">{{ cat.label }}</div>
            </div>
        {% endfor %}
    </div>
    <script src="{% static 'custom/js/centrodefamilia.js' %}"></script>
{% endblock %}