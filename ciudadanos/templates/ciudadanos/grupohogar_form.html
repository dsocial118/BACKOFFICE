{% extends "includes/main.html" %} {% load crispy_forms_tags %} {% load static
%} {% block head %}
<!--jquery confirm-->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.css"
/>
<link
  rel="stylesheet"
  href="{% static 'custom/css/ciudadano-detail-enhanced.css' %}"
/>
<style>
  /* Estilos específicos para formularios de hogar (mismos que familia) */
  .bs-stepper {
    background: rgba(255, 255, 255, 0.06);
    backdrop-filter: blur(12px);
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.15);
  }

  .bs-stepper-header {
    padding: 1.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .step-trigger {
    color: rgba(255, 255, 255, 0.7) !important;
    text-decoration: none;
  }

  .step.active .step-trigger {
    color: var(--gov-accent) !important;
  }

  .bs-stepper-circle {
    background: var(--gov-medium) !important;
    color: white !important;
    border: 2px solid rgba(255, 255, 255, 0.2);
  }

  .step.active .bs-stepper-circle {
    background: linear-gradient(
      135deg,
      var(--gov-primary),
      var(--gov-accent)
    ) !important;
    border-color: var(--gov-accent);
    box-shadow: 0 4px 12px rgba(23, 162, 184, 0.4);
  }

  .users-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .users-list li {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
  }

  .users-list li:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
  }

  .users-list img {
    border-radius: 50%;
    border: 3px solid rgba(255, 255, 255, 0.2);
    margin-bottom: 0.5rem;
  }

  .users-list-name {
    display: block;
    font-weight: 600;
    color: white;
    margin-bottom: 0.25rem;
  }

  .users-list-date {
    display: block;
    color: var(--gov-muted);
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
  }

  #nuevo_ciudadano_familiar {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 12px;
    margin-top: 1rem;
    padding: 1rem;
  }

  .empty-state {
    padding: 3rem 1rem;
    text-align: center;
  }

  .empty-state i {
    opacity: 0.5;
  }
</style>
{% endblock %} {% block title %}Grupo Hogar{% endblock %} {% block titulo-pagina
%}Ciudadano{% endblock %} {% block breadcrumb %}
<ol class="breadcrumb float-sm-right mt-2 mr-2">
  <li class="breadcrumb-item">
    <a href="{% url 'ciudadanos' %}">Ciudadano</a>
  </li>
  <li class="breadcrumb-item">
    <a href="{% url 'ciudadanos_ver' pk %}">{{ ciudadano_principal }}</a>
  </li>
  <li class="breadcrumb-item active">Grupo Hogar</li>
</ol>
{% endblock %} {% block content %}
<div class="row">
  <div class="col-md-12">
    <div class="card shadow-lg">
      <div class="card-body p-4">
        <!-- Stepper usando componente existente -->
        {% include "components/wizard/stepper_navigation.html" with
        current_step=4 ciudadano_id=pk %}

        <!-- Resumen del ciudadano principal -->
        <div class="row mt-4 mb-4">
          <div class="col-md-4">
            {% include "components/ciudadanos/ciudadano_summary_card.html" with
            ciudadano=ciudadano_principal card_class="mb-0" %}
          </div>
          <div class="col-md-8">
            <div class="card shadow-sm h-100">
              <div class="card-header">
                <h5 class="mb-0">
                  <i class="fas fa-home me-2"></i>Información del Hogar
                </h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="info-item mb-3">
                      <h6 class="text-info mb-1">
                        <i class="fas fa-users me-2"></i>Convivientes
                        Registrados
                      </h6>
                      <span class="badge bg-primary fs-6"
                        >{{ hogar_count_familia }} persona{{
                        hogar_count_familia|pluralize }}</span
                      >
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="info-item mb-3">
                      <h6 class="text-success mb-1">
                        <i class="fas fa-house-user me-2"></i>Tipo de Hogar
                      </h6>
                      <span class="badge bg-success">
                        {% if hogar_count_familia > 1 %}
                        <i class="fas fa-users me-1"></i>Multifamiliar {% else
                        %} <i class="fas fa-user me-1"></i>Unipersonal {% endif
                        %}
                      </span>
                    </div>
                  </div>
                </div>
                <div
                  class="alert alert-info border-0"
                  style="background: rgba(23, 162, 184, 0.1)"
                >
                  <i class="fas fa-lightbulb me-2"></i>
                  <strong>Paso 4 de 6:</strong> Configure las personas que
                  conviven en el mismo hogar. Esto incluye familiares y no
                  familiares que comparten vivienda.
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Convivientes existentes usando componente -->
        <div class="row">
          <div class="col-12">
            {% include "components/ciudadanos/familiares_grid.html" with familiares=hogar_display ciudadano_id=pk grid_title="Grupo Hogar Actual" show_actions=True show_vinculo=False edit_url="ciudadanos_editar" delete_url="ciudadanos_eliminar" %}
          </div>
        </div>

        <!-- Búsqueda y agregar convivientes usando componente -->
        <div class="row mt-4">
          <div class="col-12">
            {% include "components/ciudadanos/busqueda_ciudadanos_table.html"
            with search_placeholder="Buscar conviviente..." show_vinculo=False
            show_estado_relacion=True show_convive=False show_cuidador=False
            extra_columns='' %}
          </div>
        </div>

        <!-- Formulario para nuevo conviviente -->
        <div class="row d-none" id="nuevo_ciudadano_familiar">
          <div class="col-12">
            <div class="card shadow-sm">
              <div class="card-header">
                <h5 class="mb-0">
                  <i class="fas fa-user-plus me-2"></i>Registrar Nuevo
                  Conviviente
                </h5>
              </div>
              <div class="card-body">
                <div
                  class="alert alert-warning border-0 mb-4"
                  style="background: rgba(255, 193, 7, 0.1)"
                >
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  <strong>No se encontraron resultados.</strong>
                  Complete el formulario para registrar un nuevo conviviente del
                  hogar.
                </div>

                <form
                  autocomplete="off"
                  method="POST"
                  novalidate
                  id="formulario-nuevo"
                >
                  {% csrf_token %}
                  <input type="hidden" name="pk" value="{{ pk }}" />

                  <!-- Renderizar todos los campos del formulario automáticamente -->
                  <div class="row justify-content-center">
                    <div class="col-md-10">
                      <h6 class="text-info mb-4 text-center">
                        <i class="fas fa-home me-2"></i>Información del
                        Conviviente
                      </h6>

                      <!-- Usar el formulario completo para evitar errores -->
                      <div class="row">
                        {% for field in form %} {% if field.name != 'pk' %}
                        <div class="col-md-6 mb-3">
                          {{ field|as_crispy_field }}
                        </div>
                        {% endif %} {% endfor %}
                      </div>

                      <div
                        class="alert alert-info border-0 mt-3"
                        style="
                          background: rgba(23, 162, 184, 0.1);
                          font-size: 0.875rem;
                        "
                      >
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Nota:</strong> El grupo hogar incluye todas las
                        personas que conviven en la misma vivienda,
                        independientemente de si son familiares o no.
                      </div>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-12 text-center mt-4">
                      <button
                        type="button"
                        class="btn btn-outline-secondary me-3"
                        onclick="$('#nuevo_ciudadano_familiar').addClass('d-none')"
                      >
                        <i class="fas fa-times me-1"></i>Cancelar
                      </button>
                      <button
                        type="submit"
                        name="form_nuevo"
                        id="form_nuevo"
                        class="btn btn-primary"
                      >
                        <i class="fas fa-user-plus me-1"></i>Registrar
                        Conviviente
                      </button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- Botones del formulario usando componente -->
        {% include "components/forms/step_form_buttons.html" with
        back_url="grupofamiliar_crear" back_id=pk save_url="ciudadanos_ver"
        save_id=pk continue_url="alertas_crear" continue_id=pk
        back_label="Volver" save_label="Guardar" continue_label="Continuar" %}
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block customJS %}
<script>
  const searchUrl = "{% url 'hogar_buscar' %}";
  const createUrl = "{% url 'grupohogar_ajax_crear' %}";
  const deleteUrl = "{% url 'grupohogar_ajax_borrar' %}";
  const pk1 = "{{ pk }}";
  const formEstadoRelacion = "{{ form.estado_relacion|escapejs }}";
  const mediaUrl = "{{ MEDIA_URL }}";
  const staticUrl = "{% static '' %}";
</script>
<script src="{% static 'custom/js/grupohogarform.js' %}"></script>
{% endblock %}
