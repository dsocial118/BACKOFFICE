{% load static %}
{% with pagina_actual=request.resolver_match.route %}
    <nav class="app-header navbar navbar-expand bg-body">
        <div class="container-fluid">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" data-lte-toggle="sidebar" href="#" role="button">
                        <i class="bi bi-list"></i>
                    </a>
                </li>
            </ul>
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <span class="nav-link">
                        <i class="bi bi-person-fill"></i> <strong>{{ user.username }}</strong>
                    </span>
                </li>
                <li class="nav-item circle-btn dropdown">
                    <button class="btn btn-link nav-link d-flex align-items-center"
                            id="bd-theme"
                            type="button"
                            aria-expanded="false"
                            data-bs-toggle="dropdown"
                            data-bs-display="static">
                        <span class="theme-icon-active ms-2"><i class=""></i></span>
                        <span class="d-lg-none" id="bd-theme-text"></span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end"
                        aria-labelledby="bd-theme-text"
                        style="--bs-dropdown-min-width: 8rem">
                        <li>
                            <button type="button"
                                    class="dropdown-item d-flex align-items-center active"
                                    data-bs-theme-value="light"
                                    aria-pressed="false">
                                <i class="bi bi-sun-fill me-2"></i>
                                Claro
                                <i class="bi bi-check-lg ms-auto d-none"></i>
                            </button>
                        </li>
                        <li>
                            <button type="button"
                                    class="dropdown-item d-flex align-items-center"
                                    data-bs-theme-value="dark"
                                    aria-pressed="false">
                                <i class="bi bi-moon-fill me-2"></i>
                                Oscuro
                                <i class="bi bi-check-lg ms-auto d-none"></i>
                            </button>
                        </li>
                    </ul>
                </li>
                <li class="nav-item circle-btn">
                    <a class="nav-link" href="#" data-lte-toggle="fullscreen">
                        <i data-lte-icon="maximize" class="bi bi-arrows-fullscreen"></i>
                        <i data-lte-icon="minimize"
                           class="bi bi-fullscreen-exit"
                           style="display: none"></i>
                    </a>
                </li>
                <li class="nav-item circle-btn">
                    <a class="nav-link" href="{% url 'logout' %}">
                        <i class="bi bi-box-arrow-right"></i>
                    </a>
                </li>
            </ul>
        </div>
    </nav>
    <script>
    (() => {
        "use strict";

        const storedTheme = localStorage.getItem("theme");

        const getPreferredTheme = () => {
            if (storedTheme) {
                return storedTheme;
            }
            return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
        };

        const setTheme = function(theme) {
            if (theme === "auto" && window.matchMedia("(prefers-color-scheme: dark)").matches) {
                document.documentElement.setAttribute("data-bs-theme", "dark");
            } else {
                document.documentElement.setAttribute("data-bs-theme", theme);
            }
        };

        const showActiveTheme = (theme, focus = false) => {
            const themeSwitcher = document.querySelector("#bd-theme");
            if (!themeSwitcher) return;

            const themeSwitcherText = document.querySelector("#bd-theme-text");
            const activeThemeIcon = document.querySelector(".theme-icon-active i");
            const btnToActive = document.querySelector(`[data-bs-theme-value="${theme}"]`);
            if (!btnToActive || !activeThemeIcon) return;

            const iconClass = btnToActive.querySelector("i")?.getAttribute("class");
            if (!iconClass) return;

            document.querySelectorAll("[data-bs-theme-value]").forEach(el => {
                el.classList.remove("active");
                el.setAttribute("aria-pressed", "false");
            });

            btnToActive.classList.add("active");
            btnToActive.setAttribute("aria-pressed", "true");
            activeThemeIcon.setAttribute("class", iconClass);

            if (themeSwitcherText) {
                const themeLabel = `${themeSwitcherText.textContent} (${btnToActive.dataset.bsThemeValue})`;
                themeSwitcher.setAttribute("aria-label", themeLabel);
            }

            if (focus) themeSwitcher.focus();
        };

        setTheme(getPreferredTheme());

        window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", () => {
            if (storedTheme !== "light" && storedTheme !== "dark") {
                setTheme(getPreferredTheme());
            }
        });

        window.addEventListener("DOMContentLoaded", () => {
            showActiveTheme(getPreferredTheme());

            document.querySelectorAll("[data-bs-theme-value]").forEach(toggle => {
                toggle.addEventListener("click", () => {
                    const theme = toggle.getAttribute("data-bs-theme-value");
                    localStorage.setItem("theme", theme);
                    setTheme(theme);
                    showActiveTheme(theme, true);
                });
            });
        });
    })();
    </script>
{% endwith %}
