{% extends "includes/main.html" %}
{% load static %}
{% block title %}Comedor: {{ comedor.nombre }}{% endblock %}
{% block titulo-pagina %}
    {{ comedor.nombre }}
    <span class="ms-2 h5">| {{ comedor.provincia.nombre | default_if_none:"Sin información" }}, {{ comedor.municipio.nombre | default_if_none:"Sin información" }}, {{ comedor.localidad.nombre | default_if_none:"Sin información" }}</span>
    <span class="ms-2 h5">- {{ comedor.programa.nombre }} - {{ comedor_categoria.categoria.nombre }}</span>
{% endblock %}
{% block breadcrumb %}
    {% include 'components/breadcrumb.html' with items=breadcrumb_items %}
{% endblock %}
{% load crispy_forms_tags %}
{% block content %}
    <link rel="stylesheet" href="{% static 'custom/css/cardsDetail.css' %}" />
    <link rel="stylesheet"
          href="{% static 'custom/css/comedorRelevamiento.css' %}" />
    <link rel="stylesheet"
          href="{% static 'custom/css/galeria-imagenes.css' %}" />
    <div class="row justify-content-between d-print-none mx-1 mb-3">
        <div class="col-auto">
            <a href="{% url 'comedores' %}"
               class="btn btn-secondary me-1 backbutton-handler">Volver</a>
        </div>
        <div class="col-auto">
            {% if rendicion_cuentas_final_activo == True %}
                <a href="{% url 'rendicion_cuentas_final' pk=comedor.id %}"
                   class="btn btn-primary me-1">Rendicion de Cuentas Final</a>
            {% endif %}
            <a href="{% url 'nomina_ver' pk=comedor.id %}"
               class="btn btn-primary me-1">Nomina</a>
            {% if comedor.estado == "Sin Ingreso" %}
                <a href="{% url 'dupla_asignar' pk=comedor.id %}"
                   class="btn btn-primary me-1">Asignar Dupla</a>
            {% else %}
                <button type="button"
                        class="btn btn-warning text-white me-1 fw-bold"
                        data-bs-toggle="modal"
                        data-bs-target="#modalAdmision">
                    <i class="bi bi-box-arrow-in-right me-1"></i> Comenzar Admisión
                </button>
                <a href="{% url 'dupla_asignar' pk=comedor.id %}"
                   class="btn btn-primary me-1">Modificar Dupla</a>
            {% endif %}
            <a href="{% url 'comedor_intervencion_ver' comedor.id %}"
               class="btn btn-primary me-1">Intervenciones</a>
            <a href="{% url 'comedor_editar' comedor.id %}"
               class="btn btn-primary me-1">Editar</a>
            <a href="#" class="btn btn-secondary print me-1 d-none d-sm-inline">Imprimir</a>
            <a href="{% url 'comedor_eliminar' comedor.id %}" class="btn btn-danger">Eliminar</a>
        </div>
    </div>
    <div class="row text-center mb-3">
        <div class="col-xl-2 col-lg-4 col-md-4 col-sm-6 pt-3">
            <div class="info-card bg-card">
                <div class="row">
                    <div class="col-3">
                        <i class="fa fa-clipboard fa-2x"></i>
                    </div>
                    <div class="col-9 text-start">
                        <p>{{ count_relevamientos }}</p>
                    </div>
                </div>
                <div class="row info-card-label">
                    <h5 class="mt-2">Relevamientos</h5>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-lg-4 col-md-4 col-sm-6 pt-3">
            <div class="info-card bg-card">
                <div class="row">
                    <div class="col-3">
                        <i class="fa fa-users fa-2x"></i>
                    </div>
                    <div class="col-9 text-start">
                        <p>{{ count_beneficiarios }}</p>
                    </div>
                </div>
                <div class="row info-card-label">
                    <h5 class="mt-2">Beneficiarios</h5>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-lg-4 col-md-4 col-sm-6 pt-3">
            <div class="info-card bg-card">
                <div class="row">
                    <div class="col-3">
                        <i class="fa fa-coffee fa-2x"></i>
                    </div>
                    <div class="col-9 text-start">
                        <p>{{ presupuesto_desayuno }}</p>
                    </div>
                </div>
                <div class="row info-card-label">
                    <h5 class="mt-2">Presupuesto Desayuno</h5>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-lg-4 col-md-4 col-sm-6 pt-3">
            <div class="info-card bg-card">
                <div class="row">
                    <div class="col-3">
                        <i class="fa fa-utensils fa-2x"></i>
                    </div>
                    <div class="col-9 text-start">
                        <p>{{ presupuesto_almuerzo }}</p>
                    </div>
                </div>
                <div class="row info-card-label">
                    <h5 class="mt-2">Presupuesto Almuerzo</h5>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-lg-4 col-md-4 col-sm-6 pt-3">
            <div class="info-card bg-card">
                <div class="row">
                    <div class="col-3">
                        <i class="fa fa-mug-hot fa-2x"></i>
                    </div>
                    <div class="col-9 text-start">
                        <p>{{ presupuesto_merienda }}</p>
                    </div>
                </div>
                <div class="row info-card-label">
                    <h5 class="mt-2">Presupuesto Merienda</h5>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-lg-4 col-md-4 col-sm-6 pt-3">
            <div class="info-card bg-card">
                <div class="row">
                    <div class="col-3">
                        <i class="fa fa-concierge-bell fa-2x"></i>
                    </div>
                    <div class="col-9 text-start">
                        <p>{{ presupuesto_cena }}</p>
                    </div>
                </div>
                <div class="row info-card-label">
                    <h5 class="mt-2">Presupuesto Cena</h5>
                </div>
            </div>
        </div>
    </div>
    <div class="row relevamiento-container">
        <div class="col-6">
            <div class="row">
                <div class="col-12">
                    <div class="card card-informacion">
                        <div class="card-header">
                            <h3 class="card-title fw-bold me-3 pt-1">Información</h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body card-comments p-0 pb-1">
                            <div class="nav nav-pills row my-3">
                                <div class="col-6">
                                    <div class="row">
                                        <div class="col-6 w-100">
                                            <div class="nav-item d-flex">
                                                <div class="comment-text comment-text d-flex flex-column min-width-100">
                                                    {% if comedor.foto_legajo %}
                                                        <img src="/media/{{ comedor.foto_legajo }}"
                                                             alt="Imagen del comedor"
                                                             class="img-fluid mw-100 rounded" />
                                                    {% else %}
                                                        <img src="{% static 'custom/img/default.png' %}"
                                                             alt="Imagen del comedor"
                                                             class="img-fluid mw-100 rounded" />
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="row">
                                        <div class="nav-item d-flex col-6">
                                            <div class="comment-text comment-text d-flex flex-column">
                                                Nombre
                                                <span class="username">{{ comedor.nombre | default_if_none:"Sin información" }}</span>
                                            </div>
                                        </div>
                                        <div class="nav-item d-flex col-6">
                                            <div class="comment-text comment-text d-flex flex-column">
                                                ID Externo
                                                <span class="username">{{ comedor.id_externo | default_if_none:"Sin información" }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="nav-item d-flex col-6">
                                            <div class="comment-text comment-text d-flex flex-column">
                                                Codigo de Proyecto
                                                <span class="username">{{ comedor.codigo_de_proyecto | default_if_none:"Sin información" }}</span>
                                            </div>
                                        </div>
                                        <div class="nav-item d-flex col-6">
                                            <div class="comment-text comment-text d-flex flex-column">
                                                Tipo de Comedor
                                                <span class="username">{{ comedor.tipocomedor.nombre | default_if_none:"Sin información" }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="nav-item d-flex col-6">
                                            <div class="comment-text comment-text d-flex flex-column">
                                                Organización
                                                <span class="username">{{ comedor.organizacion.nombre | default_if_none:"Sin información" }}</span>
                                            </div>
                                        </div>
                                        <div class="nav-item d-flex col-6">
                                            <div class="comment-text comment-text d-flex flex-column">
                                                Año de comienzo
                                                <span class="username">{{ comedor.comienzo | default_if_none:"Sin información" }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="nav-item d-flex col-6">
                                            <div class="comment-text comment-text d-flex flex-column">
                                                Provincia
                                                <span class="username">{{ comedor.provincia.nombre | default_if_none:"Sin información" }}</span>
                                            </div>
                                        </div>
                                        <div class="nav-item d-flex col-6">
                                            <div class="comment-text comment-text d-flex flex-column">
                                                Municipio
                                                <span class="username">{{ comedor.municipio.nombre | default_if_none:"Sin información" }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="nav-item d-flex col-6">
                                            <div class="comment-text comment-text d-flex flex-column">
                                                Localidad
                                                <span class="username">{{ comedor.localidad.nombre | default_if_none:"Sin información" }}</span>
                                            </div>
                                        </div>
                                        <div class="nav-item d-flex col-6">
                                            <div class="comment-text comment-text d-flex flex-column">
                                                Partido
                                                <span class="username">{{ comedor.partido | default_if_none:"Sin información" }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="nav-item d-flex col-6">
                                            <div class="comment-text comment-text d-flex flex-column">
                                                Barrio
                                                <span class="username">{{ comedor.barrio | default_if_none:"Sin información" }}</span>
                                            </div>
                                        </div>
                                        <div class="nav-item d-flex col-6">
                                            <div class="comment-text comment-text d-flex flex-column">
                                                Codigo postal
                                                <span class="username">{{ comedor.codigo_postal | default_if_none:"Sin información" }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="nav-item col-6">
                                            <div class="comment-text comment-text d-flex flex-column">
                                                Calle
                                                <span class="username">{{ comedor.calle | default_if_none:"Sin información" }}</span>
                                            </div>
                                        </div>
                                        <div class="nav-item col-6">
                                            <div class="comment-text comment-text d-flex flex-column">
                                                Número
                                                <span class="username">{{ comedor.numero | default_if_none:"Sin información" }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="nav-item col-6">
                                            <div class="comment-text comment-text d-flex flex-column">
                                                Piso
                                                <span class="username">{{ comedor.piso | default_if_none:"Sin información" }}</span>
                                            </div>
                                        </div>
                                        <div class="nav-item col-6">
                                            <div class="comment-text comment-text d-flex flex-column">
                                                Departamento
                                                <span class="username">{{ comedor.departamento | default_if_none:"Sin información" }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="nav-item col-6">
                                            <div class="comment-text comment-text d-flex flex-column">
                                                Manzana
                                                <span class="username">{{ comedor.manzana | default_if_none:"Sin información" }}</span>
                                            </div>
                                        </div>
                                        <div class="nav-item col-6">
                                            <div class="comment-text comment-text d-flex flex-column">
                                                Lote
                                                <span class="username">{{ comedor.lote | default_if_none:"Sin información" }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="nav-item col-6">
                                            <div class="comment-text comment-text d-flex flex-column">
                                                Entre calle 1
                                                <span class="username">{{ comedor.entre_calle_1 | default_if_none:"Sin información" }}</span>
                                            </div>
                                        </div>
                                        <div class="nav-item col-6">
                                            <div class="comment-text comment-text d-flex flex-column">
                                                Entre calle 2
                                                <span class="username">{{ comedor.entre_calle_2 | default_if_none:"Sin información" }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="nav-item col-6">
                                            <div class="comment-text comment-text d-flex flex-column">
                                                Longitud
                                                <span class="username">{{ comedor.longitud | default_if_none:"Sin información" }}</span>
                                            </div>
                                        </div>
                                        <div class="nav-item col-6">
                                            <div class="comment-text comment-text d-flex flex-column">
                                                Latitud
                                                <span class="username">{{ comedor.latitud | default_if_none:"Sin información" }}</span>
                                            </div>
                                        </div>
                                        <div class="nav-item d-flex col-12">
                                            <div class="comment-text comment-text d-flex flex-column">
                                                Estado
                                                <span class="username">{{ comedor.estado }}</span>
                                            </div>
                                        </div>
                                        <div class="nav-item d-flex col-12">
                                            <div class="comment-text comment-text d-flex flex-column">
                                                Estado general
                                                <span class="username">{{ comedor.estado_general }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title font-weight-bold">Ubicación</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0" style="height: 400px;">
                    {% if comedor.calle and comedor.numero and comedor.localidad and comedor.municipio and comedor.provincia %}
                        <iframe width="100%"
                                height="100%"
                                frameborder="0"
                                style="border:0"
                                src="https://maps.google.com/maps?q={{ comedor.calle|urlencode }}+{{ comedor.numero }},+{{ comedor.localidad.nombre|urlencode }},+{{ comedor.municipio.nombre|urlencode }},+{{ comedor.provincia.nombre|urlencode }}&output=embed"
                                allowfullscreen>
                        </iframe>
                    {% else %}
                        <div class="p-4 text-center text-muted">No hay datos de dirección suficientes para mostrar el mapa.</div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="row relevamiento-container">
            <div class="col-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title font-weight-bold me-3 pt-1">Referente</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body card-comments p-0 pb-1">
                        <div class="nav nav-pills row my-3">
                            <div class="nav-item col-3 d-flex">
                                <div class="comment-text comment-text d-flex flex-column">
                                    Nombre completo
                                    {% if comedor.referente.nombre %}
                                        <span class="username">{{ comedor.referente.nombre | default_if_none:"Sin información" }}, {{ comedor.referente.apellido | default_if_none:"Sin información" }}</span>
                                    {% else %}
                                        <span class="username">Sin información</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="nav-item col-3 d-flex">
                                <div class="comment-text comment-text d-flex flex-column">
                                    Numero de contacto
                                    <span class="username">{{ comedor.referente.celular | default_if_none:"Sin información" }}</span>
                                </div>
                            </div>
                            <div class="nav-item col-3 d-flex">
                                <div class="comment-text comment-text d-flex flex-column">
                                    Mail de contacto
                                    <span class="username" style="word-break: break-all;"><a href="mailto:{{ relevamiento.comedor.referente.mail }}">{{ comedor.referente.mail |   default_if_none:"Sin información" }}</a></span>
                                </div>
                            </div>
                            <div class="nav-item col-3 d-flex">
                                <div class="comment-text comment-text d-flex flex-column">
                                    Documento
                                    <span class="username">{{ comedor.referente.documento |   default_if_none:"Sin información" }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title font-weight-bold me-3 pt-1">Relevamientos</h3>
                        <div class="card-tools">
                            <a href="{% url 'relevamientos' comedor.id %}"
                               class="btn btn-primary btn-sm me-3">Ver mas</a>
                            <button type="button"
                                    class="btn btn-primary btn-sm"
                                    data-bs-toggle="modal"
                                    data-bs-target="#RelevamientoModal">Agregar</button>
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body row card-comments p-0 pb-1">
                        {% for relevamiento in relevamientos %}
                            <div class="nav nav-pills row my-3">
                                <div class="col-4 d-flex align-self-center">
                                    <a href="{% url 'relevamiento_detalle' comedor.id relevamiento.id %}">{{ relevamiento.id }} - {{ relevamiento.fecha_visita|default_if_none:"Pendiente" }}</a>
                                </div>
                                <div class="col-4 d-flex align-self-center">
                                    <p {% if relevamiento.estado == "Pendiente" %} style="color: yellow;" {% elif relevamiento.estado == "Visita pendiente" %} style="color: green;" {% else %} style="color: white;" {% endif %}
                                       class="m-0">{{ relevamiento.estado }}</p>
                                </div>
                                {% if relevamiento.estado != "Finalizado" and relevamiento.estado != "Finalizado/Excepciones" %}
                                    <button type="button"
                                            class="btn btn-primary col-4"
                                            data-bs-toggle="modal"
                                            data-bs-target="#RelevamientoModalEditar-{{ relevamiento.id }}">
                                        Asignar
                                    </button>
                                    <div class="modal fade"
                                         id="RelevamientoModalEditar-{{ relevamiento.id }}"
                                         tabindex="-1"
                                         aria-labelledby="RelevamientoModalEditarLabel"
                                         aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="RelevamientoModalEditarLabel">Asignar territorial a relevamiento {{ relevamiento.id }}</h5>
                                                    <button type="button"
                                                            class="btn-close"
                                                            data-bs-dismiss="modal"
                                                            aria-label="Close"></button>
                                                </div>
                                                <form method="post"
                                                      action="{% url 'relevamiento_create_edit_ajax' comedor.pk %}">
                                                    {% csrf_token %}
                                                    <div class="modal-body">
                                                        <div class="mb-3">
                                                            <input type="hidden" name="relevamiento_id" value="{{ relevamiento.id }}" />
                                                            <label for="inputField" class="form-label">Territorial</label>
                                                            <select name="territorial_editar"
                                                                    id="update_territorial_select"
                                                                    class="form-control">
                                                                <option value="">No definido</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                                        <button type="submit" class="btn btn-primary">Guardar</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                        <div class="modal fade"
                             id="RelevamientoModal"
                             tabindex="-1"
                             aria-labelledby="RelevamientoModalLabel"
                             aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="RelevamientoModalLabel">Nuevo relevamiento</h5>
                                        <button type="button"
                                                class="btn-close"
                                                data-bs-dismiss="modal"
                                                aria-label="Close"></button>
                                    </div>
                                    <form method="post"
                                          action="{% url 'relevamiento_create_edit_ajax' comedor.pk %}">
                                        {% csrf_token %}
                                        <div class="modal-body">
                                            <div class="mb-3">
                                                <label for="inputField" class="form-label">Territorial</label>
                                                <select name="territorial" id="new_territorial_select" class="form-control">
                                                    <option value="">No definido</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                            <button type="submit" class="btn btn-primary">Guardar</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row relevamiento-container">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title font-weight-bold me-3 pt-1">Detalles Admisiones</h3>
                        <div class="card-tools">
                            <a href="{% url 'dupla_asignar' pk=comedor.id %}"
                               class="btn btn-primary me-1 btn-sm">
                                {% if comedor.estado == "Sin Ingreso" %}
                                    Asignar Dupla
                                {% else %}
                                    Modificar Dupla
                                {% endif %}
                            </a>
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-1 m-1">
                        <style>
                        .table-compact {
                            font-size: 0.85rem;
                        }
                        .table-compact th,
                        .table-compact td {
                            padding: 0.3rem 0.5rem;
                            vertical-align: middle;
                        }
                        .table-compact .btn {
                            padding: 0.2rem 0.5rem;
                            font-size: 0.8rem;
                        }
                        </style>
                        {% if admisiones_items %}
                            <div class="table-responsive">
                                <table class="table table-bordered table-striped table-sm table-compact">
                                    <thead>
                                        <tr>
                                            {% for header in admisiones_headers %}<th>{{ header.title }}</th>{% endfor %}
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in admisiones_items %}
                                            <tr>
                                                {% for cell in item.cells %}<td>{{ cell.content }}</td>{% endfor %}
                                                <td>
                                                    {% for action in item.actions %}
                                                        <a href="{{ action.url }}" class="btn btn-{{ action.type }} btn-sm">{{ action.label }}</a>
                                                    {% endfor %}
                                                    {% if user.is_superuser and not item.enviada_a_archivo and not item.enviado_acompaniamiento %}
                                                        <button class="btn btn-danger btn-sm"
                                                                data-bs-toggle="modal"
                                                                data-bs-target="#descartarModal"
                                                                data-admision-id="{{ item.admision_id }}">
                                                            Descartar Expediente
                                                        </button>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="p-3 text-center text-muted">
                                <i class="fas fa-inbox fa-2x mb-2"></i>
                                <p>No hay admisiones registradas</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
 
        <!-- Modal Descartar Expediente -->
        <div class="modal fade"
             id="descartarModal"
             tabindex="-1"
             aria-labelledby="descartarModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="descartarModalLabel">Descartar Expediente</h5>
                        <button type="button"
                                class="btn-close"
                                data-bs-dismiss="modal"
                                aria-label="Close"></button>
                    </div>
                    <form method="post" action="{% url 'comedor_detalle' comedor.pk %}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="descartar_expediente" />
                        <input type="hidden" name="admision_id" id="admisionId" />
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="motivoDescarte" class="form-label">Motivo de descarte del expediente *</label>
                                <textarea class="form-control"
                                          id="motivoDescarte"
                                          name="motivo_descarte"
                                          rows="4"
                                          required></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-danger">Descartar Expediente</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
 
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const descartarModal = document.getElementById('descartarModal');
            descartarModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const admisionId = button.getAttribute('data-admision-id');
                document.getElementById('admisionId').value = admisionId;
            });
        });
        </script>
 
        <div class="row relevamiento-container">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title font-weight-bold me-3 pt-1">Observaciones</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body row card-comments p-0 pb-1">
                        <div class="nav nav-pills row col-10 my-3">
                            {% for observacion in observaciones %}
                                <div class="col-2 d-flex">
                                    <a href="{% url 'observacion_detalle' comedor.id observacion.id %}">{{ observacion.id }} - {{ observacion.fecha_visita }}</a>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="card-tools col-2 d-flex justify-content-end align-items-start my-3">
                            <a href="{% url 'observacion_crear' comedor.id %}"
                               class="btn btn-primary">Agregar</a>
                            <button type="button" class="btn btn-tool" data-card-widget="collapse"></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row relevamiento-container">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title font-weight-bold me-3 pt-1">Historial de programas</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if programa_history %}
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered table-hover table-sm mb-0">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Programa anterior</th>
                                            <th>Programa actual</th>
                                            <th>Usuario</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for change in programa_history %}
                                            <tr>
                                                <td>{{ change.changed_at|date:"d/m/Y H:i" }}</td>
                                                <td>{{ change.from_programa.nombre|default:"Sin información" }}</td>
                                                <td>{{ change.to_programa.nombre|default:"Sin información" }}</td>
                                                <td>{{ change.changed_by.get_full_name|default:change.changed_by.username|default:"Sin información" }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="mb-0 text-muted">No se han registrado actualizaciones en el programa.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class="row relevamiento-container">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title font-weight-bold me-3 pt-1">
                            <i class="fas fa-images me-2"></i>
                            Galería de Imágenes
                        </h3>
                        <div class="card-tools">
                            <span class="badge badge-primary me-2">{{ imagenes|length }} imagen{{ imagenes|length|pluralize:"es" }}</span>
                            <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                <i class="fas fa-minus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-3">
                        {% if imagenes %}
                            <div class="galeria-imagenes">
                                {% for imagen in imagenes %}
                                    <div class="imagen-item" data-index="{{ forloop.counter0 }}">
                                        <div class="imagen-container" data-image-url="{{ imagen.imagen.url }}">
                                            <div class="placeholder-imagen">
                                                <i class="fas fa-image"></i>
                                                <div class="loader">
                                                    <div class="spinner-border spinner-border-sm" role="status">
                                                        <span class="sr-only">Cargando...</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="imagen-overlay">
                                                <button type="button"
                                                        class="btn-expandir"
                                                        onclick="abrirModal({{ forloop.counter0 }})">
                                                    <i class="fas fa-expand-alt"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="imagen-info">
                                            <div class="imagen-nombre">
                                                {% if "comedor/" in imagen.imagen.name %}
                                                    {{ imagen.imagen.name|slice:"8:" }}
                                                {% else %}
                                                    {{ imagen.imagen.name }}
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="sin-imagenes">
                                <div class="text-center py-5">
                                    <i class="fas fa-image fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No hay imágenes disponibles</h5>
                                    <p class="text-muted">Las imágenes del comedor aparecerán aquí una vez que sean cargadas.</p>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% if contactos_duplas_cargados %}
            <div class="row relevamiento-container">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title font-weight-bold me-3 pt-1">Contactos Duplas</h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-1">
                            <div class="container m-0 table-responsive">
                                <table class="table table-striped table-bordered table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Usuario</th>
                                            <th>Tipo</th>
                                            <th>Observaciones</th>
                                        </tr>
                                    </thead>
                                    {% for contacto  in contactos_duplas_cargados %}
                                        <tbody>
                                            <td>{{ contacto.fecha |date:'d/m/Y' }}</td>
                                            <td>{{ contacto.usuario | default_if_none:"Sin información" }}</td>
                                            <td>{{ contacto.tipo | default_if_none:"Sin información" }}</td>
                                            <td>{{ contacto.observaciones | default_if_none:"Sin información" }}</td>
                                        </tbody>
                                    {% endfor %}
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        <!-- Modal para vista ampliada de imágenes -->
        <div class="modal fade"
             id="imagenModal"
             tabindex="-1"
             aria-labelledby="imagenModalLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content modal-imagen">
                    <div class="modal-header border-0">
                        <h5 class="modal-title" id="imagenModalLabel">
                            <i class="fas fa-image me-2"></i>
                            Imagen del comedor
                        </h5>
                        <button type="button"
                                class="btn-close"
                                data-bs-dismiss="modal"
                                aria-label="Cerrar">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body p-0">
                        <div class="imagen-modal-container">
                            <div class="imagen-principal">
                                <img id="imagenPrincipal" src="" alt="Imagen ampliada" class="img-fluid" />
                                <div class="controles-navegacion">
                                    <button type="button"
                                            class="btn-nav btn-anterior"
                                            onclick="cambiarImagen(-1)">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <button type="button"
                                            class="btn-nav btn-siguiente"
                                            onclick="cambiarImagen(1)">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-0 justify-content-between">
                        <div class="info-imagen">
                            <span class="nombre-archivo" id="nombreArchivo">imagen.jpg</span>
                            <span class="contador-imagenes" id="contadorImagenes">1 de 5</span>
                        </div>
                        <div class="acciones-imagen">
                            <button type="button"
                                    class="btn btn-outline-primary btn-sm"
                                    onclick="descargarImagen()">
                                <i class="fas fa-download me-1"></i>Descargar
                            </button>
                            <button type="button"
                                    class="btn btn-secondary btn-sm"
                                    data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- MODAL SELECCION ADMISION -->
        <div class="modal fade"
             id="modalAdmision"
             tabindex="-1"
             aria-labelledby="modalAdmisionLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <form method="POST" action="">
                        {% csrf_token %}
                        <div class="modal-header">
                            <h5 class="modal-title">Seleccione el tipo de Admisión</h5>
                            <button type="button"
                                    class="btn-close"
                                    data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <select name="admision"
                                    id="admisionID"
                                    class="form-control form-select"
                                    required>
                                <option value="" disabled selected>-- Seleccione --</option>
                                <option value="incorporacion">Incorporación</option>
                                <option value="renovacion">Renovación</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary" id="seleccionAdmision">Seleccionar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    {% endblock %}
    {% block customJS %}
        <script>
        const comedorId = "{{ comedor.id }}"
        const GESTIONAR_API_KEY = "{{ GESTIONAR_API_KEY }}";
        const GESTIONAR_API_CREAR_COMEDOR = "{{ GESTIONAR_API_CREAR_COMEDOR }}";
        </script>
        <script src="{% static 'custom/js/galeria-imagenes.js' %}"></script>
        <script src="{% static 'custom/js/comedordetail_territorial_cache.js' %}"></script>
        <script src="{% static 'custom/js/comedordetail.js' %}"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
                integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
                crossorigin="anonymous"></script>
    {% endblock %}
