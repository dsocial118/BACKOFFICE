{% extends "includes/main.html" %}
{% load static custom_filters %}
{% block title %}Expedientes Celiaquía{% endblock %}

{% block breadcrumb %}
  <ol class="breadcrumb float-sm-right">
    <li class="breadcrumb-item">
      <a href="{% url 'expediente_list' %}">Expedientes</a>
    </li>
    <li class="breadcrumb-item active">Listar</li>
  </ol>
{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="h3">
      {% if request.user|has_group:"CoordinadorCeliaquia" %}Bandeja de Subsecretaría
      {% elif request.user|has_group:"TecnicoCeliaquia" %}Mis Expedientes Asignados
      {% else %}Mis Expedientes{% endif %}
    </h2>

    {% if request.user|has_group:"ProvinciaCeliaquia" %}
      <a href="{% url 'expediente_create' %}" class="btn btn-primary">
        <i class="fa fa-plus-circle me-1"></i> Nuevo Expediente
      </a>
    {% endif %}
  </div>

  <div id="list-alerts"></div>

  <form method="get" class="mb-3">
    <div class="input-group input-group-lg">
      <input type="search"
             name="q"
             value="{{ request.GET.q }}"
             class="form-control form-control-lg"
             placeholder="Buscar por código o estado…" />
      <button class="btn btn-lg btn-outline-secondary" type="submit">
        <i class="fa fa-search"></i>
      </button>
    </div>
  </form>

  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover table-striped mb-0">
        <thead class="table-light">
          <tr>
            <th>Código</th>
            <th>Fecha creación</th>
            <th>Estado</th>
            {% if request.user|has_group:"CoordinadorCeliaquia" or request.user|has_group:"TecnicoCeliaquia" %}
              <th>Técnico</th>
            {% endif %}
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for exp in expedientes %}
            <tr data-exp-id="{{ exp.pk }}">
              <td>
                <a href="{% url 'expediente_detail' exp.pk %}" class="fw-bold">{{ exp.codigo }}</a>
              </td>
              <td>{{ exp.fecha_creacion|date:"d/m/Y H:i" }}</td>
              <td>
                <span class="badge
                  {% if exp.estado.nombre == 'CREADO' %}bg-secondary
                  {% elif exp.estado.nombre == 'EN_ESPERA' %}bg-info
                  {% elif exp.estado.nombre == 'CONFIRMACION_DE_ENVIO' %}bg-warning
                  {% elif exp.estado.nombre == 'ASIGNADO' %}bg-primary
                  {% elif exp.estado.nombre == 'PROCESO_DE_CRUCE' %}bg-dark
                  {% elif exp.estado.nombre == 'CRUCE_FINALIZADO' %}bg-success
                  {% else %}bg-light text-dark{% endif %}">
                  {{ exp.estado.display_name }}
                </span>
              </td>

              {% if request.user|has_group:"CoordinadorCeliaquia" or request.user|has_group:"TecnicoCeliaquia" %}
                <td>
                  {% if exp.asignacion_tecnico %}
                    {{ exp.asignacion_tecnico.tecnico.get_full_name|default:exp.asignacion_tecnico.tecnico.username }}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>
              {% endif %}

              <td class="text-end">
                <a href="{% url 'expediente_detail' exp.pk %}" class="btn btn-sm btn-outline-primary">Ver</a>

                {# === Acciones para PROVINCIA === #}
                {% if request.user|has_group:"ProvinciaCeliaquia" %}
                  {% if exp.estado.nombre == 'CREADO' %}
                    <a href="{% url 'expediente_update' exp.pk %}"
                       class="btn btn-sm btn-outline-secondary">Editar</a>
                    <button
                      type="button"
                      class="btn btn-sm btn-primary js-process"
                      data-process-url="{% url 'expediente_procesar' exp.pk %}">
                      Procesar
                    </button>
                  {% elif exp.estado.nombre == 'EN_ESPERA' %}
                    <button
                      type="button"
                      class="btn btn-sm btn-success js-confirm"
                      data-confirm-url="{% url 'expediente_confirm' exp.pk %}">
                      Confirmar Envío
                    </button>
                  {% endif %}
                {% endif %}

                {# === Acciones para SUBSECRETARÍA (Coordinador) === #}
                {% if request.user|has_group:"CoordinadorCeliaquia" %}
                  {% if exp.estado.nombre == 'CONFIRMACION_DE_ENVIO' %}
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-success js-recepcionar"
                      data-recepcionar-url="{% url 'expediente_recepcionar' exp.pk %}">
                      Recepcionar
                    </button>
                  {% elif exp.estado.nombre == 'ASIGNADO' %}
                    <a href="{% url 'expediente_detail' exp.pk %}#asignacion-tecnico"
                       class="btn btn-sm btn-outline-warning">
                      Cambiar técnico
                    </a>
                  {% endif %}
                {% endif %}

                {# === Acciones para TÉCNICO (por ahora sólo Ver; acciones llegan en etapa 3/4) === #}
                {% if request.user|has_group:"TecnicoCeliaquia" %}
                  {# Lugar para "Iniciar revisión" o "Cruce CUIT" en etapas siguientes #}
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="{% if request.user|has_group:'CoordinadorCeliaquia' or request.user|has_group:'TecnicoCeliaquia' %}5{% else %}4{% endif %}"
                  class="text-center text-muted py-3">
                No hay expedientes registrados.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if is_paginated %}
      <div class="card-footer">
        <nav>
          <ul class="pagination justify-content-center mb-0">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">« Anterior</a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">« Anterior</span>
              </li>
            {% endif %}
            {% for i in page_obj.paginator.page_range %}
              {% if page_obj.number == i %}
                <li class="page-item active"><span class="page-link">{{ i }}</span></li>
              {% elif i >= page_obj.number|add:"-2" and i <= page_obj.number|add:"2" %}
                <li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
              {% endif %}
            {% endfor %}
            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}">Siguiente »</a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">Siguiente »</span>
              </li>
            {% endif %}
          </ul>
        </nav>
      </div>
    {% endif %}
  </div>
{% endblock %}

{% block customJS %}
  <script>
    // CSRF global para requests AJAX de esta lista
    window.CSRF_TOKEN = "{{ csrf_token }}";
  </script>
  <script src="{% static 'custom/js/celiaquia_list.js' %}"></script>
{% endblock %}
