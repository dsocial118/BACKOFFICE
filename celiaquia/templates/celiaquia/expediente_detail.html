{% extends "includes/main.html" %}
{% load static %}
{% load celiaquia_filters %}

{% block title %}Detalle de Expediente{% endblock %}

{% block content %}
<div class="container">
  <h2 class="mt-4 mb-3">Detalle del Expediente</h2>
   <div class="d-flex justify-content-end gap-2 flex-wrap m-3">
      {% if expediente.estado.nombre == "Creado" %}
        <a href="{% url 'celiaquia_expedientes_formulario' expediente.id %}" class="btn btn-info">Cargar Personas</a>
        <form method="post" action="{% url 'celiaquia_expedientes_confirmar' expediente.id %}" class="d-inline">
          {% csrf_token %}
          <button type="submit" class="btn btn-success">Finalizar Expediente</button>
        </form>
      {% endif %}

      {% if puede_subir_cruces %}
        <a href="{% url 'celiaquia_cruce_archivos_subir' expediente.id %}" class="btn btn-warning">Subir Archivos de Cruce</a>
      {% endif %}

      {% if puede_confirmar_nomina %}
        <form method="post" action="{% url 'celiaquia_cruce_validar' expediente.id %}" class="d-inline">
          {% csrf_token %}
          <button type="submit" class="btn btn-success">Confirmar Nómina</button>
        </form>
      {% endif %}
      <a href="{% url 'celiaquia_carga_masiva' expediente.id %}" class="btn btn-outline-primary">Carga Masiva Excel</a>

    </div>

  <div class="card mb-4">
    <div class="card-header"><strong>Información del Expediente</strong></div>
    <div class="card-body">
      <p><strong>ID:</strong> {{ expediente.id }}</p>
      <p><strong>Estado:</strong> {{ expediente.estado.nombre }}</p>
      <p><strong>Fecha de creación:</strong> {{ expediente.fecha_creacion }}</p>
      {% if expediente.tecnico_asignado %}
        <p><strong>Técnico asignado:</strong> {{ expediente.tecnico_asignado.get_full_name|default:expediente.tecnico_asignado.username }}</p>
      {% endif %}
    </div>
  </div>

  {% if expediente.estado.nombre == "Finalizado por Provincia" and tecnicos %}
<div class="card mb-4">
  <div class="card-header"><strong>Asignar Técnico</strong></div>
  <div class="card-body">
    <form method="post" action="{% url 'celiaquia_expedientes_asignar' expediente.id %}">
      {% csrf_token %}
      <div class="form-group">
        <label for="tecnico">Seleccionar Técnico:</label>
        <select name="tecnico" id="tecnico" class="form-control" required>
          {% for tecnico in tecnicos %}
            <option value="{{ tecnico.id }}">{{ tecnico.get_full_name|default:tecnico.username }}</option>
          {% endfor %}
        </select>
      </div>
      <button type="submit" class="btn btn-primary mt-2">Asignar</button>
    </form>
  </div>
</div>
{% endif %}
  

    {% if resultado_cruce %}
    <div class="card mb-4">
    <div class="card-header"><strong>Nómina Final Validada</strong></div>
    <div class="card-body">
        <ul>
        {% for fila in resultado_cruce %}
            <li>{{ fila.dni }}</li>
        {% endfor %}
        </ul>
    </div>
    </div>
    {% endif %}


  {% if page_obj %}
    <div class="card mb-4">
      <div class="card-header"><strong>Ciudadanos Cargados</strong></div>
      <div class="card-body table-responsive">
        <table class="table table-striped table-bordered">
          <thead class="thead-light">
            <tr>
              <th>Apellido</th>
              <th>Nombre</th>
              <th>DNI</th>
              <th>Sexo</th>
              <th>Fecha de Nacimiento</th>
            </tr>
          </thead>
          <tbody>
            {% for persona in page_obj %}
              <tr>
                <td>{{ persona.apellido }}</td>
                <td>{{ persona.nombre }}</td>
                <td>{{ persona.dni }}</td>
                <td>{{ persona.sexo }}</td>
                <td>{{ persona.fecha_nacimiento }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="pagination">
      <span class="step-links">
        {% if page_obj.has_previous %}
          <a href="?page=1">&laquo; Primero</a>
          <a href="?page={{ page_obj.previous_page_number }}">Anterior</a>
        {% endif %}

        <span class="current">
          Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}.
        </span>

        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}">Siguiente</a>
          <a href="?page={{ page_obj.paginator.num_pages }}">Última &raquo;</a>
        {% endif %}
      </span>
    </div>
  {% else %}
    <div class="alert alert-info mt-3">No hay personas asociadas al expediente.</div>
  {% endif %}

  {% if expediente.archivos_cruce.exists %}
    <div class="card mb-4">
      <div class="card-header"><strong>Archivos de Cruce</strong></div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered table-striped">
            <thead class="thead-light">
              <tr>
                <th>Archivo</th>
                <th>Organismo</th>
                <th>Tipo</th>
                <th>Fecha de subida</th>
              </tr>
            </thead>
            <tbody>
              {% for archivo in expediente.archivos_cruce.all %}
                <tr>
                  <td>
                    <a href="{{ archivo.archivo.url }}" target="_blank">
                      {{ archivo.archivo.name|cut:"cruces/" }}
                    </a>
                  </td>
                  <td>{{ archivo.get_organismo_display }}</td>
                  <td>{{ archivo.get_tipo_display }}</td>
                  <td>{{ archivo.fecha_subida|date:"d/m/Y H:i" }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% else %}
    {% if puede_subir_cruces %}
      <div class="alert alert-info">Todavía no se han subido archivos de cruce.</div>
    {% endif %}
  {% endif %}

  <div class="mt-3">
    <a href="{% url 'celiaquia_expedientes_listar' %}" class="btn btn-secondary">Volver al listado</a>
  </div>
</div>
{% endblock %}
