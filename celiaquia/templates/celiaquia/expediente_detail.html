{% extends "includes/main.html" %}
{% load static custom_filters %}
{% block title %}Expediente{% endblock %}
{% block breadcrumb %}
    <ol class="breadcrumb float-sm-right">
        <li class="breadcrumb-item">
            <a href="{% url 'expediente_list' %}">Expedientes</a>
        </li>
        <li class="breadcrumb-item active"></li>
    </ol>
{% endblock %}
{% block content %}
    {% with
        is_tec=request.user|has_group:"TecnicoCeliaquia"
        is_coord=request.user|has_group:"CoordinadorCeliaquia"
        is_prov=request.user|has_group:"ProvinciaCeliaquia"
        %}
        <style>
    /* Extras sutiles para legajos */
    .card-dark { background-color:#1f2d3d; color:#e9eef5; border:1px solid #2a3a4f; }
    .chip { display:inline-flex; align-items:center; gap:.4rem; padding:.2rem .6rem; border-radius:999px; font-size:.75rem; }
    .chip-warning { background:#ffe08a; color:#3b2f00; }
    .badge-soft { background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); }
    .file-row { display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding:.35rem .6rem; border-radius:.5rem; }
    .file-row + .file-row { margin-top:.35rem; }
    .file-name { max-width: 32ch; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:inline-block; vertical-align:bottom; }
    .muted { color:#9fb3c8!important; }
    .list-divider { border-top:1px dashed rgba(255,255,255,.12); margin:.6rem 0; }
    .btn-toolbar.flex-wrap > .btn-group { margin-bottom:.4rem; }
        </style>
        <div class="mb-3 d-flex justify-content-between align-items-center">
            <div>
                <a href="{% url 'expediente_list' %}"
                   class="btn btn-outline-secondary btn-sm">← Volver</a>
                {% if expediente.estado.nombre == 'CREADO' %}
                    <a href="{% url 'expediente_update' expediente.pk %}"
                       class="btn btn-outline-primary btn-sm ms-2">Editar Metadatos</a>
                {% endif %}
            </div>
            <div class="d-flex gap-2">
                {# Subir/Reprocesar Cruce: Técnico o Coordinador, no Provincia #}
                {% if is_tec or is_coord %}
                    {% if expediente.estado.nombre == 'ASIGNADO' or expediente.estado.nombre == 'PROCESO_DE_CRUCE' %}
                        <a href="{% url 'expediente_nomina_sintys_export' expediente.pk %}"
                           class="btn btn-outline-success btn-sm me-2">Descargar nómina Sintys</a>
                        <button type="button"
                                class="btn btn-success btn-sm me-2"
                                data-bs-toggle="modal"
                                data-bs-target="#modalCruceCuit"
                                data-mode="new">Subir Excel de Documentos (Cruce)</button>
                    {% endif %}
                    {% if expediente.cruce_excel %}
                        {% if expediente.estado.nombre == 'ASIGNADO' or expediente.estado.nombre == 'PROCESO_DE_CRUCE' %}
                            <button type="button"
                                    class="btn btn-warning btn-sm"
                                    data-bs-toggle="modal"
                                    data-bs-target="#modalCruceCuit"
                                    data-mode="reprocess">Reprocesar cruce</button>
                        {% endif %}
                    {% endif %}
                {% endif %}
            </div>
        </div>
        {% if cupo_metrics %}
            <div class="p-3 rounded shadow mb-4"
                 style="background-color:#11202e;
                        color:#e0e0e0">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-3">Provincial de {{ expediente.usuario_provincia.profile.provincia|default:"-" }}</h5>
                </div>
                <div class="row g-3">
                    <div class="col-sm-6 col-lg-3">
                        <div class="border rounded p-3 h-100" style="background:#1b2a3b;">
                            <div class="small text-muted">Total asignado</div>
                            <div class="h4 mb-0">{{ cupo_metrics.total_asignado }}</div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="border rounded p-3 h-100" style="background:#1b2a3b;">
                            <div class="small text-muted">Usados</div>
                            <div class="h4 mb-0">{{ cupo_metrics.usados }}</div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="border rounded p-3 h-100" style="background:#1b2a3b;">
                            <div class="small text-muted">Disponibles</div>
                            <div class="h4 mb-0">{{ cupo_metrics.disponibles }}</div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="border rounded p-3 h-100" style="background:#1b2a3b;">
                            <div class="small text-muted">Fuera de cupo</div>
                            <div class="h4 mb-0">{{ fuera_count }}</div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        <div id="expediente-alerts"></div>
        <div class="p-3 rounded shadow mb-4"
             style="background-color: #1c2a3a;
                    color: #e0e0e0">
            <h5 class="mb-3">Detalle del Expediente</h5>
            <div class="row">
                <div class="col-md-6">
                    <p>
                        <strong>Número de expediente:</strong> {{ expediente.numero_expediente|default:"-" }}
                    </p>
                    <p>
                        <strong>Estado:</strong> {{ expediente.estado.display_name }}
                    </p>
                    <p>
                        <strong>Fecha de creación:</strong> {{ expediente.fecha_creacion|date:"d/m/Y" }}
                    </p>
                    {% if expediente.documento %}
                        <p class="mb-0">
                            <strong>PRD generado:</strong>
                            <a href="{{ expediente.documento.url }}"
                               target="_blank"
                               class="text-decoration-underline">ver documento</a>
                        </p>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <p>
                        <strong>Provincia:</strong> {{ expediente.usuario_provincia.profile.provincia|default:"-" }}
                    </p>
                    <p>
                        <strong>Técnicos asignados:</strong>
                        {% if expediente.asignaciones_tecnicos.exists %}
                            {% for asignacion in expediente.asignaciones_tecnicos.all %}
                                <span class="badge bg-info me-1">{{ asignacion.tecnico.get_full_name|default:asignacion.tecnico.username }}</span>
                            {% endfor %}
                        {% else %}
                            <span class="text-muted">No asignado</span>
                        {% endif %}
                    </p>

                </div>
            </div>
        </div>
        {% if is_coord %}
            <div class="p-3 rounded shadow mb-4"
                 style="background-color:#1c2a3a;
                        color:#e0e0e0">
                <h5 class="mb-3">Historial de estados</h5>
                <div class="list-group">
                    {% for h in historial_page_obj %}
                        <div class="list-group-item border-0 mb-3 rounded shadow-sm card-dark">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <div class="fw-semibold">{{ h.fecha|date:"d/m/Y H:i" }}</div>
                                    <div class="small">{{ h.estado_anterior.display_name }} → {{ h.estado_nuevo.display_name }}</div>
                                </div>
                                <div class="text-end small">
                                    {% if h.usuario %}{{ h.usuario.get_full_name|default:h.usuario.username }}{% endif %}
                                    {% if h.observaciones %}<div class="text-muted mt-1">{{ h.observaciones }}</div>{% endif %}
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <p class="text-muted mb-0">Sin cambios de estado.</p>
                    {% endfor %}
                </div>
                {% if historial_page_obj.paginator.num_pages > 1 %}
                    <nav class="mt-3">
                        <ul class="pagination pagination-sm mb-0">
                            {% if historial_page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link"
                                       href="?{% for key, value in request.GET.items %}{% if key != 'historial_page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}historial_page={{ historial_page_obj.previous_page_number }}"
                                       aria-label="Anterior">&laquo;</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">&laquo;</span>
                                </li>
                            {% endif %}
                            {% for num in historial_page_obj.paginator.page_range %}
                                {% if num == historial_page_obj.number %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% else %}
                                    <li class="page-item">
                                        <a class="page-link"
                                           href="?{% for key, value in request.GET.items %}{% if key != 'historial_page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}historial_page={{ num }}">{{ num }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            {% if historial_page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link"
                                       href="?{% for key, value in request.GET.items %}{% if key != 'historial_page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}historial_page={{ historial_page_obj.next_page_number }}"
                                       aria-label="Siguiente">&raquo;</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">&raquo;</span>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                {% endif %}
            </div>
        {% endif %}
        {% if fuera_de_cupo %}
            <div class="p-3 rounded shadow mb-4"
                 style="background-color:#1c2a3a;
                        color:#e0e0e0">
                <h5 class="mb-3">Lista de espera (Fuera de cupo)</h5>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered mb-0" style="color:#fff;">
                        <thead style="background:#13212f;">
                            <tr>
                                <th>DNI</th>
                                <th>Nombre</th>
                                <th>Apellido</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for l in fuera_de_cupo %}
                                <tr>
                                    <td>{{ l.ciudadano.documento }}</td>
                                    <td>{{ l.ciudadano.nombre }}</td>
                                    <td>{{ l.ciudadano.apellido }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endif %}
        {% if preview %}
            <div class="p-3 rounded shadow mb-4"
                 style="background-color: #1c2a3a;
                        color: #e0e0e0">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-3">Vista previa del Excel</h5>
                    <div class="d-flex align-items-center gap-2">
                        <label for="preview-page-size" class="me-2 mb-0 small">Registros por página:</label>
                        <select id="preview-page-size"
                                class="form-select form-select-sm"
                                style="width: auto">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="15">15</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="all">Todos</option>
                        </select>
                    </div>
                </div>
                <div id="preview-error-detail" class="text-danger mb-2"></div>
                <div class="table-responsive">
                    <table id="preview-table" class="table table-bordered table-sm">
                        <thead style="background-color: #13212f; color: #fff;">
                            <tr>
                                {% for h in preview.headers %}<th>{{ h|capfirst }}</th>{% endfor %}
                            </tr>
                        </thead>
                        <tbody id="preview-tbody">
                            {% for row in preview.rows %}
                                <tr class="preview-row">
                                    {% for h in preview.headers %}<td>{{ row|get_item:h }}</td>{% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <nav>
                    <ul id="preview-pagination"
                        class="pagination pagination-sm justify-content-center mb-0">
                    </ul>
                </nav>
                {% if expediente.estado.nombre == 'CREADO' %}
                    <button id="btn-process-expediente" class="btn btn-primary mt-3">Procesar Expediente</button>
                {% endif %}
            </div>
        {% elif preview_error %}
            <div class="alert alert-danger">{{ preview_error }}</div>
        {% endif %}
        <div class="p-3 rounded shadow mb-4"
             style="background-color: #1c2a3a;
                    color: #e0e0e0">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-3">Legajos</h5>
                <div class="d-flex align-items-center gap-2">
                    <label for="legajos-page-size" class="me-2 mb-0 small">Registros por página:</label>
                    <select id="legajos-page-size"
                            class="form-select form-select-sm"
                            style="width: auto">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="15">15</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="all">Todos</option>
                    </select>
                </div>
            </div>
            {% if legajos %}
                {% if faltan_archivos %}
                    <div class="alert alert-warning">
                        Para enviar el expediente, todos los legajos deben tener <strong>los 2 archivos requeridos</strong>.
                        <ul class="mt-2 mb-0">
                            {% for leg in legajos %}
                                {% with m2=leg.archivo2 m3=leg.archivo3 %}
                                    {% if not m2 or not m3 %}
                                        <li>
                                            {{ leg.ciudadano.apellido }}, {{ leg.ciudadano.nombre }} (DNI {{ leg.ciudadano.documento }}):
                                            {% if not m2 %}<span class="text-danger">falta biopsia/constancia médica</span>{% endif %}
                                            {% if not m3 %}
                                                {% if not m2 %}—{% endif %}
                                                <span class="text-danger">falta negativa ANSES</span>
                                            {% endif %}
                                        </li>
                                    {% endif %}
                                {% endwith %}
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
                <div id="legajos-list" class="list-group">
                    {% for leg in legajos %}
                        <div class="list-group-item border-0 mb-3 rounded shadow-sm legajo-item card-dark {% if leg.revision_tecnico == 'SUBSANAR' %}border-warning{% elif leg.revision_tecnico == 'SUBSANADO' %}border-info{% endif %}"
                             data-legajo-id="{{ leg.pk }}"
                             data-revision="{{ leg.revision_tecnico }}"
                             {% if leg.revision_tecnico == 'SUBSANAR' %}style="border: 2px solid #ffc107 !important;"
                             {% elif leg.revision_tecnico == 'SUBSANADO' %}style="border: 2px solid #17a2b8 !important;"{% endif %}>
                            <div class="row gy-3 gx-3">
                                <!-- Col 1: Datos + Revisión -->
                                <div class="col-lg-3 col-md-5">
                                    <div class="d-flex align-items-center mb-1">
                                        {% if leg.revision_tecnico == 'SUBSANAR' %}
                                            <span class="me-2" style="font-size: 1.2em;">⚠️</span>
                                        {% endif %}
                                        <div class="fw-semibold h6 mb-0">{{ leg.ciudadano.nombre }} {{ leg.ciudadano.apellido }}</div>
                                    </div>
                                    <div class="muted small mb-2">DNI: {{ leg.ciudadano.documento }}</div>
                                    {% if leg.revision_tecnico == 'SUBSANAR' and leg.subsanacion_solicitada_en %}
                                        <div class="small text-warning mb-2">Solicitado: {{ leg.subsanacion_solicitada_en|date:"d/m/Y H:i" }}</div>
                                    {% endif %}
                                    <div class="small">
                                        <span class="muted">Revisión:</span>
                                        {% if leg.revision_tecnico == 'APROBADO' %}
                                            <span class="badge bg-success">Aprobado</span>
                                        {% elif leg.revision_tecnico == 'RECHAZADO' %}
                                            <span class="badge bg-danger">Rechazado</span>
                                        {% elif leg.revision_tecnico == 'SUBSANAR' %}
                                            <span class="badge bg-warning text-dark">Subsanar</span>
                                        {% elif leg.revision_tecnico == 'SUBSANADO' %}
                                            <span class="badge bg-info text-dark">Subsanado</span>
                                        {% else %}
                                            <span class="badge badge-soft">Pendiente</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <!-- Col 2: Observación de Subsanación -->
                                <div class="col-lg-4 col-md-7">
                                    {% if is_prov %}
                                        <div class="small muted">Observación (subsanación):</div>
                                        <div class="mt-1">
                                            {% if leg.subsanacion_motivo %}
                                                <div class="p-2 rounded"
                                                     style="background:rgba(255,255,255,.04);
                                                            border:1px solid rgba(255,255,255,.08)">
                                                    <span class="d-block text-break">{{ leg.subsanacion_motivo }}</span>
                                                </div>
                                            {% else %}
                                                <span class="muted">—</span>
                                            {% endif %}
                                        </div>
                                        {% if leg.subsanacion_renaper_comentario %}
                                            <div class="small muted mt-2">Respuesta provincia:</div>
                                            <div class="mt-1">
                                                <div class="p-2 rounded"
                                                     style="background:rgba(255,193,7,.1);
                                                            border:1px solid rgba(255,193,7,.3)">
                                                    <span class="d-block text-break">{{ leg.subsanacion_renaper_comentario }}</span>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <div class="small muted">Comentario enviado a provincia:</div>
                                        <div class="mt-1">
                                            {% if leg.subsanacion_motivo %}
                                                <div class="p-2 rounded"
                                                     style="background:rgba(255,255,255,.04);
                                                            border:1px solid rgba(255,255,255,.08)">
                                                    <span class="d-block text-break">{{ leg.subsanacion_motivo }}</span>
                                                </div>
                                            {% else %}
                                                <span class="muted">—</span>
                                            {% endif %}
                                        </div>
                                        {% if leg.subsanacion_renaper_comentario %}
                                            <div class="small muted mt-2">Respuesta de provincia:</div>
                                            <div class="mt-1">
                                                <div class="p-2 rounded"
                                                     style="background:rgba(40,167,69,.1);
                                                            border:1px solid rgba(40,167,69,.3)">
                                                    <span class="d-block text-break">{{ leg.subsanacion_renaper_comentario }}</span>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                </div>
                                <!-- Col 3: Archivos -->
                                <div class="col-lg-5">
                                    <div class="small muted mb-1">Archivos del legajo</div>
                                    <!-- Archivo 2 -->
                                    <div class="file-row"
                                         style="background:rgba(255,255,255,.03);
                                                border:1px solid rgba(255,255,255,.08)">
                                        <div>
                                            <div class="muted small">Biopsia positiva y/o constancia médica</div>
                                            {% if leg.archivo2 %}
                                                <a href="{{ leg.archivo2.url }}"
                                                   target="_blank"
                                                   class="text-success text-decoration-underline file-name">
                                                    ✅ {{ leg.archivo2.name }}
                                                </a>
                                            {% else %}
                                                <span class="text-warning">⚠ Pendiente</span>
                                            {% endif %}
                                        </div>
                                        {% if is_prov %}
                                            {% if expediente.estado.nombre == 'EN_ESPERA' or leg.revision_tecnico == 'SUBSANAR' %}
                                            <button type="button"
                                                    class="btn btn-outline-info btn-sm"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#modalSubirArchivo"
                                                    data-legajo-id="{{ leg.pk }}"
                                                    data-expediente-id="{{ expediente.pk }}"
                                                    data-file-field="archivo2">
                                                {% if leg.archivo2 %}
                                                    Editar
                                                {% else %}
                                                    Subir
                                                {% endif %}
                                            </button>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    <!-- Archivo 3 -->
                                    <div class="file-row"
                                         style="background:rgba(255,255,255,.03);
                                                border:1px solid rgba(255,255,255,.08)">
                                        <div>
                                            <div class="muted small">Negativa de ANSES</div>
                                            {% if leg.archivo3 %}
                                                <a href="{{ leg.archivo3.url }}"
                                                   target="_blank"
                                                   class="text-success text-decoration-underline file-name">
                                                    ✅ {{ leg.archivo3.name }}
                                                </a>
                                            {% else %}
                                                <span class="text-warning">⚠ Pendiente</span>
                                            {% endif %}
                                        </div>
                                        {% if is_prov %}
                                        {% if expediente.estado.nombre == 'EN_ESPERA' or leg.revision_tecnico == 'SUBSANAR' %}
                                            <button type="button"
                                                    class="btn btn-outline-info btn-sm"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#modalSubirArchivo"
                                                    data-legajo-id="{{ leg.pk }}"
                                                    data-expediente-id="{{ expediente.pk }}"
                                                    data-file-field="archivo3">
                                                {% if leg.archivo3 %}
                                                    Editar
                                                {% else %}
                                                    Subir
                                                {% endif %}
                                            </button>
                                        {% endif %}
                                        {% endif %}
                                    </div>
                                    <!-- Respuesta Subsanación Renaper -->
                                    {% if leg.estado_validacion_renaper == 3 and is_prov %}
                                        <div class="file-row mt-2"
                                             style="background:rgba(255,193,7,.1);
                                                    border:1px solid rgba(255,193,7,.3)">
                                            <div>
                                                <div class="muted small">Respuesta subsanación Renaper</div>
                                                {% if leg.subsanacion_renaper_archivo %}
                                                    <a href="{{ leg.subsanacion_renaper_archivo.url }}"
                                                       target="_blank"
                                                       class="text-success text-decoration-underline file-name">
                                                        ✅ {{ leg.subsanacion_renaper_archivo.name }}
                                                    </a>
                                                {% else %}
                                                    <span class="text-warning">⚠ Pendiente respuesta</span>
                                                {% endif %}
                                            </div>
                                            <button type="button"
                                                    class="btn btn-outline-warning btn-sm"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#modalRespuestaSubsanacionRenaper"
                                                    data-legajo-id="{{ leg.pk }}"
                                                    data-expediente-id="{{ expediente.pk }}">
                                                {% if leg.subsanacion_renaper_archivo %}
                                                    Editar Respuesta
                                                {% else %}
                                                    Responder
                                                {% endif %}
                                            </button>
                                        </div>
                                    {% elif leg.revision_tecnico == 'SUBSANAR' and leg.estado_validacion_renaper != 3 and leg.subsanacion_renaper_archivo %}
                                        <div class="file-row mt-2"
                                             style="background:rgba(255,193,7,.1);
                                                    border:1px solid rgba(255,193,7,.3)">
                                            <div>
                                                <div class="muted small">Documento subsanación</div>
                                                <a href="{{ leg.subsanacion_renaper_archivo.url }}"
                                                   target="_blank"
                                                   class="text-success text-decoration-underline file-name">
                                                    ✅ {{ leg.subsanacion_renaper_archivo.name }}
                                                </a>
                                            </div>
                                            {% if is_prov %}
                                                <button type="button"
                                                        class="btn btn-outline-warning btn-sm"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#modalRespuestaSubsanacionRenaper"
                                                        data-legajo-id="{{ leg.pk }}"
                                                        data-expediente-id="{{ expediente.pk }}">
                                                    Editar
                                                </button>
                                            {% endif %}
                                        </div>
                                    {% elif leg.revision_tecnico == 'SUBSANADO' and leg.subsanacion_renaper_archivo %}
                                        <div class="file-row mt-2"
                                             style="background:rgba(40,167,69,.1);
                                                    border:1px solid rgba(40,167,69,.3)">
                                            <div>
                                                <div class="muted small">Documento subsanación</div>
                                                <a href="{{ leg.subsanacion_renaper_archivo.url }}"
                                                   target="_blank"
                                                   class="text-success text-decoration-underline file-name">
                                                    ✅ {{ leg.subsanacion_renaper_archivo.name }}
                                                </a>
                                            </div>
                                        </div>
                                    {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="list-divider"></div>
                            <!-- Acciones (línea separada para que no se solapen con nada) -->
                            {% if is_tec %}
                            {% if expediente.estado.nombre == 'ASIGNADO' or expediente.estado.nombre == 'PROCESO_DE_CRUCE' %}
                                {% with estado=leg.revision_tecnico %}
                                    <div class="d-flex justify-content-end">
                                        <div class="btn-toolbar flex-wrap"
                                             role="toolbar"
                                             aria-label="Acciones del legajo">
                                            {% if leg.estado_validacion_renaper == 0 %}
                                                <div class="btn-group btn-group-sm"
                                                     role="group"
                                                     aria-label="Validación Renaper">
                                                    <button type="button"
                                                            class="btn btn-info btn-validar-renaper"
                                                            title="Validar con Renaper"
                                                            data-legajo-id="{{ leg.pk }}"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#modalValidarRenaper">🔍 Validación Renaper</button>
                                                </div>
                                            {% elif leg.estado_validacion_renaper == 1 %}
                                                <div class="btn-group btn-group-sm me-2"
                                                     role="group"
                                                     aria-label="Revisión técnico">
                                                    <button type="button"
                                                            class="btn {% if estado == 'APROBADO' %}btn-success active{% else %}btn-outline-success{% endif %} btn-revision"
                                                            title="Aprobar"
                                                            data-legajo-id="{{ leg.pk }}"
                                                            data-accion="APROBAR">✅ Aprobar</button>
                                                    <button type="button"
                                                            class="btn {% if estado == 'SUBSANAR' %}btn-warning active{% else %}btn-outline-warning{% endif %} btn-subsanar"
                                                            title="Pedir subsanación"
                                                            data-legajo-id="{{ leg.pk }}"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#modalSubsanar">📝 Subsanar</button>
                                                    <button type="button"
                                                            class="btn {% if estado == 'RECHAZADO' %}btn-danger active{% else %}btn-outline-danger{% endif %} btn-revision"
                                                            title="Rechazar"
                                                            data-legajo-id="{{ leg.pk }}"
                                                            data-accion="RECHAZAR">❌ Rechazar</button>
                                                </div>
                                                <div class="btn-group btn-group-sm"
                                                     role="group"
                                                     aria-label="Validación Renaper">
                                                    <button type="button"
                                                            class="btn btn-outline-success btn-validar-renaper"
                                                            title="Ver validación Renaper"
                                                            data-legajo-id="{{ leg.pk }}"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#modalValidarRenaper">✅ Renaper</button>
                                                </div>
                                            {% elif leg.estado_validacion_renaper == 3 %}
                                                <div class="alert alert-info mb-0 py-1 px-2">
                                                    <small>📝 Renaper requiere subsanación - No se puede revisar</small>
                                                </div>
                                            {% else %}
                                                <div class="alert alert-warning mb-0 py-1 px-2">
                                                    <small>❌ Datos Renaper incorrectos - No se puede revisar</small>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endwith %}
                            {% endif %}
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
                <nav class="mt-3">
                    <ul id="legajos-pagination"
                        class="pagination pagination-sm justify-content-center mb-0">
                    </ul>
                </nav>
            {% else %}
                <p class="text-muted">No hay legajos cargados.</p>
            {% endif %}
            {# Confirmar Envío: solo Provincia en EN_ESPERA #}
            {% if legajos and is_prov and expediente.estado.nombre == 'EN_ESPERA' %}
                <div class="text-end mt-3">
                    <button id="btn-confirm" class="btn btn-success">Confirmar Envío</button>
                </div>
            {% endif %}
            {# Confirmar Subsanación: solo Provincia en ASIGNADO y si hay_subsanar #}
            {% if hay_subsanar and is_prov and expediente.estado.nombre == 'ASIGNADO' %}
                <div class="text-end mt-3">
                    <button id="btn-confirm-subs" class="btn btn-warning">Confirmar Subsanación</button>
                </div>
            {% endif %}
        </div>
        {# Asignar Técnico: solo Coordinador (según tu condición actual por id) #}
        {% if expediente.estado.id == 2 and is_coord %}
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Asignar Técnico</h5>
                </div>
                <div class="card-body">
                    <form method="post"
                          action="{% url 'expediente_asignar_tecnico' expediente.pk %}">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="tecnico">Seleccionar Técnico:</label>
                            <select name="tecnico_id" id="tecnico" class="form-control">
                                {% for tecnico in tecnicos %}
                                    <option value="{{ tecnico.id }}">{{ tecnico.get_full_name|default:tecnico.username }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary mt-2">Asignar</button>
                    </form>
                </div>
            </div>
        {% endif %}
        <!-- Modal: subir/editar archivo de legajo (individual por campo) -->
        <div class="modal fade"
             id="modalSubirArchivo"
             tabindex="-1"
             aria-labelledby="modalSubirArchivoLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <form id="form-subir-archivo" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalSubirArchivoLabel">Subir/Editar archivo del legajo</h5>
                            <button type="button"
                                    class="btn-close"
                                    data-bs-dismiss="modal"
                                    aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            <div id="modal-alertas" class="mb-2"></div>
                            <div class="row g-2">
                                <div class="col-12">
                                    <label class="form-label">Seleccionar archivo a actualizar</label>
                                    <select name="campo" id="campo-archivo" class="form-select" required>
                                        <option value="archivo2">Biopsia positiva y/o constancia médica</option>
                                        <option value="archivo3">Negativa de ANSES</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label for="id_archivo" class="form-label">PDF o imagen</label>
                                    <input type="file"
                                           name="archivo"
                                           id="id_archivo"
                                           class="form-control"
                                           required
                                           accept=".pdf,.jpg,.jpeg,.png" />
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- Modal: pedir SUBSANACIÓN -->
        <div class="modal fade"
             id="modalSubsanar"
             tabindex="-1"
             aria-labelledby="modalSubsanarLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <form class="modal-content" id="form-subsanar" method="post">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalSubsanarLabel">Solicitud de subsanación</h5>
                        <button type="button"
                                class="btn-close"
                                data-bs-dismiss="modal"
                                aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="accion" value="SUBSANAR" />
                        <input type="hidden" id="subsanar-legajo-id" name="legajo_id" value="" />
                        <div class="mb-2">
                            <label for="subsanar-motivo" class="form-label">Indicar el motivo</label>
                            <textarea id="subsanar-motivo"
                                      name="motivo"
                                      class="form-control"
                                      rows="3"
                                      required
                                      maxlength="500"></textarea>
                        </div>
                        <small class="text-muted d-block">
                            El legajo quedará en estado <strong>SUBSANAR</strong> y la provincia podrá actualizar los archivos.
                        </small>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning" id="btn-confirm-subsanar">Confirmar</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- Modal: cruce CUIT/DNI -->
        <div class="modal fade"
             id="modalCruceCuit"
             tabindex="-1"
             aria-labelledby="modalCruceCuitLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <form id="form-cruce-cuit" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalCruceCuitLabel">Subir Excel de Documentos (con encabezado)</h5>
                            <button type="button"
                                    class="btn-close"
                                    data-bs-dismiss="modal"
                                    aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            <div id="cruce-alertas" class="mb-2"></div>
                            <div class="form-group">
                                <label for="id_excel_cuit">
                                    Archivo Excel (.xlsx) con columna <code>documento</code>
                                </label>
                                <input type="file"
                                       name="excel_cuit"
                                       id="id_excel_cuit"
                                       class="form-control"
                                       required
                                       accept=".xlsx,.xls,.csv" />
                                <small id="cruce-help" class="text-muted">
                                    Debe incluir encabezado; columna válida: <strong>documento</strong>.
                                </small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-success" id="btn-cruce-submit">Ejecutar Cruce</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- Modal: Respuesta Subsanación Renaper -->
        <div class="modal fade"
             id="modalRespuestaSubsanacionRenaper"
             tabindex="-1"
             aria-labelledby="modalRespuestaSubsanacionRenaperLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <form id="form-respuesta-subsanacion-renaper" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalRespuestaSubsanacionRenaperLabel">Respuesta a Subsanación Renaper</h5>
                            <button type="button"
                                    class="btn-close"
                                    data-bs-dismiss="modal"
                                    aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            <div id="modal-alertas-renaper" class="mb-2"></div>
                            <div class="row g-2">
                                <div class="col-12">
                                    <label for="comentario-respuesta-renaper" class="form-label">Comentario de respuesta</label>
                                    <textarea id="comentario-respuesta-renaper"
                                              name="comentario"
                                              class="form-control"
                                              rows="3"
                                              placeholder="Explique las correcciones realizadas..."
                                              required></textarea>
                                </div>
                                <div class="col-12">
                                    <label for="archivo-respuesta-renaper" class="form-label">Archivo de respuesta (opcional)</label>
                                    <input type="file"
                                           name="archivo"
                                           id="archivo-respuesta-renaper"
                                           class="form-control"
                                           accept=".pdf,.jpg,.jpeg,.png" />
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-warning">Enviar Respuesta</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- Modal: Validación Renaper -->
        <div class="modal fade"
             id="modalValidarRenaper"
             tabindex="-1"
             aria-labelledby="modalValidarRenaperLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalValidarRenaperLabel">Validación Renaper</h5>
                        <button type="button"
                                class="btn-close"
                                data-bs-dismiss="modal"
                                aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div id="renaper-alertas" class="mb-3"></div>
                        <div id="renaper-loading" class="text-center py-4" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Consultando Renaper...</span>
                            </div>
                            <p class="mt-2">Consultando datos en Renaper...</p>
                        </div>
                        <div id="renaper-comparacion" style="display: none;">
                            <h6 class="mb-3">Comparación de datos: <span id="ciudadano-nombre"></span></h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0">Datos de la Provincia</h6>
                                        </div>
                                        <div class="card-body">
                                            <table class="table table-sm mb-0">
                                                <tbody id="datos-provincia">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="mb-0">Datos de Renaper</h6>
                                        </div>
                                        <div class="card-body">
                                            <table class="table table-sm mb-0">
                                                <tbody id="datos-renaper">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    {% endwith %}
{% endblock %}
{% block customJS %}
    <script>
    window.PROCESS_URL           = "{% url 'expediente_procesar' expediente.pk %}";
    window.CONFIRM_URL           = "{% url 'expediente_confirm' expediente.pk %}";
    window.CRUCE_URL             = "{% url 'expediente_cruce_cuit' expediente.pk %}";
    window.CSRF_TOKEN            = "{{ csrf_token }}";
    window.REVISAR_URL_TEMPLATE  = "{% url 'legajo_revisar' expediente.pk 0 %}".replace("/0/", "/{id}/");
    window.CONFIRM_SUBS_URL      = "{% url 'expediente_confirm_subsanacion' expediente.pk %}";
    window.VALIDAR_RENAPER_URL_TEMPLATE = "{% url 'legajo_validar_renaper' expediente.pk 0 %}".replace("/0/", "/{id}/");
    </script>
    <script src="{% static 'custom/js/utils.js' %}"></script>
    <script src="{% static 'custom/js/expediente_detail.js' %}"></script>
    <script src="{% static 'custom/js/global_pagination.js' %}"></script>
{% endblock %}
