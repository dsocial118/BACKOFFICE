{% extends "includes/main.html" %}
{% load static %}

{% block title %}Expediente {{ expediente.codigo }}{% endblock %}

{% block breadcrumb %}
<ol class="breadcrumb float-sm-right">
  <li class="breadcrumb-item"><a href="{% url 'expediente_list' %}">Expedientes</a></li>
  <li class="breadcrumb-item active">{{ expediente.codigo }}</li>
</ol>
{% endblock %}

{% block content %}
<div class="mb-3">
  <a href="{% url 'expediente_list' %}" class="btn btn-outline-secondary btn-sm">← Volver</a>
  {% if expediente.estado.nombre == 'CREADO' %}
    <form class="d-inline" method="post" action="{% url 'expediente_update' expediente.pk %}">
      {% csrf_token %}
      <button class="btn btn-outline-primary btn-sm">Editar Metadatos</button>
    </form>
  {% endif %}
</div>

{# Vista previa del Excel antes de importar #}
{% if preview %}
  <div class="card mb-4">
    <div class="card-header bg-light">
      <h5 class="mb-0">Vista previa del Excel</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              {% for h in preview.headers %}
                <th>{{ h|capfirst }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in preview.sample_rows %}
              <tr>
                {% for h in preview.headers %}
                  <td>{{ row[h] }}</td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <form method="post" action="{% url 'expediente_import' expediente.pk %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-primary mt-3">
          Crear legajos
        </button>
      </form>
    </div>
  </div>
{% elif preview_error %}
  <div class="alert alert-danger">{{ preview_error }}</div>
{% endif %}

{# Mensaje de resultado tras la importación #}
{% if import_result %}
  <div class="alert alert-info">
    Se crearon <strong>{{ import_result.validos }}</strong> legajos y
    <strong>{{ import_result.errores }}</strong> con error.
  </div>
{% endif %}

{# Tabla de legajos ya existentes en el expediente #}
<div class="card mb-4">
  <div class="card-header bg-light">
    <h5 class="mb-0">Legajos del Expediente</h5>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>DNI</th>
            <th>Nombre</th>
            <th>Estado</th>
            <th class="text-end">Archivo</th>
          </tr>
        </thead>
        <tbody>
          {% for leg in legajos %}
            <tr>
              <td>{{ leg.ciudadano.documento }}</td>
              <td>{{ leg.ciudadano.nombre }} {{ leg.ciudadano.apellido }}</td>
              <td>
                <span class="badge
                  {% if leg.estado.nombre == 'DOCUMENTO_PENDIENTE' %}bg-warning
                  {% else %}bg-success{% endif %}">
                  {{ leg.estado.display_name }}
                </span>
              </td>
              <td class="text-end">
                {% if leg.archivo %}
                  <a href="{{ leg.archivo.url }}" class="btn btn-sm btn-outline-info">Ver</a>
                {% else %}
                  <a href="{% url 'legajo_archivo_upload' expediente.pk leg.pk %}"
                     class="btn btn-sm btn-primary">
                    Subir Archivo
                  </a>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="4" class="text-center py-3 text-muted">No hay legajos cargados.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {% if legajos %}
    <div class="card-footer text-end">
      <form method="post" action="{% url 'expediente_confirm' expediente.pk %}">
        {% csrf_token %}
        <button type="submit"
                class="btn btn-success"
                {% if legajos|length != import_result.validos %}disabled{% endif %}>
          Confirmar Envío
        </button>
      </form>
    </div>
  {% endif %}
</div>
{% endblock %}
