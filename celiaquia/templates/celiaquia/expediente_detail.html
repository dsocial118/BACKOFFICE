{% extends "includes/main.html" %}
{% load static custom_filters %}

{% block title %}Expediente {{ expediente.codigo }}{% endblock %}

{% block breadcrumb %}
<ol class="breadcrumb float-sm-right">
  <li class="breadcrumb-item"><a href="{% url 'expediente_list' %}">Expedientes</a></li>
  <li class="breadcrumb-item active">{{ expediente.codigo }}</li>
</ol>
{% endblock %}

{% block content %}
<div class="mb-3 d-flex justify-content-between align-items-center">
  <div>
    <a href="{% url 'expediente_list' %}" class="btn btn-outline-secondary btn-sm">← Volver</a>
    {% if expediente.estado.nombre == 'CREADO' %}
      <a href="{% url 'expediente_update' expediente.pk %}" class="btn btn-outline-primary btn-sm ms-2">
        Editar Metadatos
      </a>
    {% endif %}
  </div>

  {# Botones de Cruce: visibles para Técnico (o admin si lo dejaste) #}
  <div class="d-flex gap-2">
    {% if request.user|has_group:"TecnicoCeliaquia" and expediente.estado.nombre in 'ASIGNADO PROCESO_DE_CRUCE' %}
      <button
        type="button"
        class="btn btn-success btn-sm me-2"
        data-bs-toggle="modal"
        data-bs-target="#modalCruceCuit"
        data-mode="new">
        Subir Excel de CUITs (Cruce)
      </button>
    {% endif %}

    {# Reprocesar: si ya existe un archivo cargado de cruce #}
    {% if request.user|has_group:"TecnicoCeliaquia" and expediente.cruce_excel %}
      <button
        type="button"
        class="btn btn-warning btn-sm"
        data-bs-toggle="modal"
        data-bs-target="#modalCruceCuit"
        data-mode="reprocess">
        Reprocesar cruce
      </button>
    {% endif %}
  </div>
</div>

<div id="expediente-alerts"></div>

<div class="p-3 rounded shadow mb-4" style="background-color: #1c2a3a; color: #e0e0e0;">
  <h5 class="mb-3">Detalle del Expediente</h5>
  <div class="row">
    <div class="col-md-6">
      <p><strong>Código:</strong> {{ expediente.codigo }}</p>
      <p><strong>Estado:</strong> {{ expediente.estado.display_name }}</p>
      <p><strong>Fecha de creación:</strong> {{ expediente.fecha_creacion|date:"d/m/Y" }}</p>
      {% if expediente.documento %}
        <p class="mb-0"><strong>PRD generado:</strong>
          <a href="{{ expediente.documento.url }}" target="_blank" class="text-decoration-underline">ver documento</a>
        </p>
      {% endif %}
    </div>
    <div class="col-md-6">
      <p><strong>Provincia:</strong> {{ expediente.provincia }}</p>
      <p><strong>Técnico asignado:</strong>
        {% if expediente.asignacion_tecnico %}
          {{ expediente.asignacion_tecnico.tecnico.get_full_name|default:expediente.asignacion_tecnico.tecnico.username }}
        {% else %}
          <span class="text-muted">No asignado</span>
        {% endif %}
      </p>
      {% if expediente.estado.id == 4 and request.user|has_group:"CoordinadorCeliaquia" %}
        <a href="{% url 'expediente_asignar_tecnico' expediente.pk %}" class="btn btn-outline-warning btn-sm">Cambiar Técnico</a>
      {% endif %}
    </div>
  </div>
</div>

{% if preview %}
  <div class="p-3 rounded shadow mb-4" style="background-color: #1c2a3a; color: #e0e0e0;">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-3">Vista previa del Excel</h5>

      {# Selector de registros por página (preview) #}
      <div class="d-flex align-items-center gap-2">
        <label for="preview-page-size" class="me-2 mb-0 small">Registros por página:</label>
        <select id="preview-page-size" class="form-select form-select-sm" style="width: auto;">
          <option value="10">10</option>
          <option value="25" selected>25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
    </div>

    <div id="preview-error-detail" class="text-danger mb-2"></div>

    <div class="table-responsive">
      <table id="preview-table" class="table table-bordered table-sm">
        <thead style="background-color: #13212f; color: #fff;">
          <tr>
            {% for h in preview.headers %}
              <th>{{ h|capfirst }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody id="preview-tbody">
          {% for row in preview.rows %}
            <tr class="preview-row">
              {% for h in preview.headers %}
                <td>{{ row|get_item:h }}</td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {# Paginación (preview) #}
    <nav>
      <ul id="preview-pagination" class="pagination pagination-sm justify-content-center mb-0"></ul>
    </nav>

    {% if expediente.estado.nombre == 'CREADO' %}
      <button id="btn-process-expediente" class="btn btn-primary mt-3">Procesar Expediente</button>
    {% endif %}
  </div>
{% elif preview_error %}
  <div class="alert alert-danger">{{ preview_error }}</div>
{% endif %}

<div class="p-3 rounded shadow mb-4" style="background-color: #1c2a3a; color: #e0e0e0;">
  <div class="d-flex justify-content-between align-items-center">
    <h5 class="mb-3">Legajos</h5>

    {# Selector de registros por página (legajos) #}
    <div class="d-flex align-items-center gap-2">
      <label for="legajos-page-size" class="me-2 mb-0 small">Registros por página:</label>
      <select id="legajos-page-size" class="form-select form-select-sm" style="width: auto;">
        <option value="10" selected>10</option>
        <option value="25">25</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
    </div>
  </div>

  {% if legajos %}
    <div id="legajos-list" class="list-group">
      {# Mostramos todos; el JS se encarga de paginar client-side #}
      {% for leg in legajos %}
        <div class="list-group-item border-0 mb-2 rounded shadow-sm legajo-item" style="background-color: #1f2d3d; color: #fff;">
          <div class="row align-items-center">
            <div class="col-md-3">
              <strong>{{ leg.ciudadano.nombre }} {{ leg.ciudadano.apellido }}</strong><br>
              <small class="text-muted">DNI: {{ leg.ciudadano.documento }}</small>
            </div>
            <div class="col-md-2">
              <strong>Estado:</strong><br>
              {% if leg.archivo %}
                <span class="badge bg-success">Con archivo</span>
              {% else %}
                <span class="badge bg-warning text-dark">Sin archivo</span>
              {% endif %}
            </div>
            <div class="col-md-4">
              {% if leg.archivo %}
                <a href="{{ leg.archivo.url }}" target="_blank" class="text-success text-decoration-underline">✅ {{ leg.archivo.name }}</a>
              {% else %}
                <span class="text-warning">⚠ Archivo pendiente</span>
              {% endif %}
            </div>
            <div class="col-md-3 text-end">
              {% if not leg.archivo and expediente.estado.nombre == 'EN_ESPERA' %}
                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalSubirArchivo" data-legajo-id="{{ leg.pk }}" data-expediente-id="{{ expediente.pk }}">
                  Subir Archivo
                </button>
              {% elif leg.archivo %}
                <button type="button"
                        class="btn btn-warning btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#modalSubirArchivo"
                        data-legajo-id="{{ leg.pk }}"
                        data-expediente-id="{{ expediente.pk }}">
                  Editar Archivo
                </button>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    {# Paginación (legajos) #}
    <nav class="mt-3">
      <ul id="legajos-pagination" class="pagination pagination-sm justify-content-center mb-0"></ul>
    </nav>
  {% else %}
    <p class="text-muted">No hay legajos cargados.</p>
  {% endif %}

  {% if legajos and expediente.estado.nombre == 'EN_ESPERA' %}
    <div class="text-end mt-3">
      <button id="btn-confirm" class="btn btn-success" {% if faltan_archivos %}disabled{% endif %}>Confirmar Envío</button>
    </div>
  {% endif %}
</div>

{% if expediente.estado.id == 2 and request.user|has_group:"CoordinadorCeliaquia" %}
  <div class="card mb-4">
    <div class="card-header bg-light"><h5 class="mb-0">Asignar Técnico</h5></div>
    <div class="card-body">
      <form method="post" action="{% url 'expediente_asignar_tecnico' expediente.pk %}">
        {% csrf_token %}
        <div class="form-group">
          <label for="tecnico">Seleccionar Técnico:</label>
          <select name="tecnico_id" id="tecnico" class="form-control">
            {% for tecnico in tecnicos %}
              <option value="{{ tecnico.id }}">{{ tecnico.get_full_name|default:tecnico.username }}</option>
            {% endfor %}
          </select>
        </div>
        <button type="submit" class="btn btn-primary mt-2">Asignar</button>
      </form>
    </div>
  </div>
{% endif %}

<!-- Modal único para subir archivo de LEGAJO -->
<div class="modal fade" id="modalSubirArchivo" tabindex="-1" aria-labelledby="modalSubirArchivoLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="form-subir-archivo" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="modalSubirArchivoLabel">Subir archivo al legajo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div id="modal-alertas" class="mb-2"></div>
          <div class="form-group">
            <label for="id_archivo">Archivo PDF o imagen</label>
            <input type="file" name="archivo" class="form-control" required accept=".pdf,.jpg,.jpeg,.png">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Subir</button>
        </div>
      </form>
    </div>
  </div>
</div>

{# Modal para CRUCE de CUITs (técnico). Sirve tanto para “nuevo” como para “reprocesar”. #}
<div class="modal fade" id="modalCruceCuit" tabindex="-1" aria-labelledby="modalCruceCuitLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="form-cruce-cuit" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="modalCruceCuitLabel">Subir Excel de CUITs (con encabezado)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div id="cruce-alertas" class="mb-2"></div>
          <div class="form-group">
            <label for="id_excel_cuit">Archivo Excel (.xlsx) con columna <code>cuit</code> o <code>dni</code></label>
            <input type="file" name="excel_cuit" id="id_excel_cuit" class="form-control" required accept=".xlsx,.xls,.csv">
            <small id="cruce-help" class="text-muted">
              Debe incluir encabezado; columnas válidas: <strong>cuit</strong> o <strong>dni</strong>.
            </small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success" id="btn-cruce-submit">Ejecutar Cruce</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block customJS %}
<script>
  window.PROCESS_URL = "{% url 'expediente_procesar' expediente.pk %}";
  window.CONFIRM_URL = "{% url 'expediente_confirm' expediente.pk %}";
  window.CRUCE_URL   = "{% url 'expediente_cruce_cuit' expediente.pk %}";
  window.CSRF_TOKEN  = "{{ csrf_token }}";
</script>
<script src="{% static 'custom/js/expediente_detail.js' %}"></script>
{% endblock %}
