<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  {% load math_extras %}
</head>
<body>
  <div id="header">
    <div class="header-left">
      PROGRAMA CELIAQUIA<br/>
    </div>
    <div class="header-right">
      <img
        src="https://www.casarosada.gob.ar/images/escudo_nacional_argentino.png"
        alt="Escudo Nacional" />
      Secretaría de Niñez, Adolescencia y Familia<br/>
      Ministerio de Capital Humano
    </div>
  </div>

  <main>
    <div class="title">Resultado de Cruce</div>
    <div class="meta">
      <div class="item">
        <b>Expediente:</b> {{ expediente.codigo }}
      </div>
      <div class="item">
        <b>Fecha:</b> {{ ahora }}
      </div>
      <div class="item">
        <b>Técnico asignado:</b>
        {% if tecnico %}
          <span class="badge">{{ tecnico }}</span>
        {% else %}
          <span class="muted">—</span>
        {% endif %}
      </div>

      <div class="item">
        <b>Usuario provincial:</b>
        {% if expediente.usuario_provincia %}
          <span class="badge">
            {{ expediente.usuario_provincia.get_full_name|default:expediente.usuario_provincia.username }}
          </span>
        {% else %}
          <span class="muted">—</span>
        {% endif %}
      </div>

      <div class="item">
        <b>Legajos en nómina (aprobados por técnico):</b> {{ resumen.total_legajos }}
      </div>
    </div>
    <div class="cards">
      <div class="card">
        <h5>Resumen de archivo</h5>
        <div class="kpi">
          <div class="kv" style="grid-column: span 2;">
            <span class="muted">Identificadores leídos (archivo)</span><br>
            <b>
              {{ resumen.total_cuits_archivo|default_if_none:0|sum2:resumen.total_dnis_archivo|default_if_none:0 }}
            </b>
            <div class="small muted">
              CUITs: {{ resumen.total_cuits_archivo|default_if_none:0 }}
              · DNIs: {{ resumen.total_dnis_archivo|default_if_none:0 }}
            </div>
          </div>
          <div class="kv"><span class="muted">Matcheados</span><br><b>{{ resumen.matcheados }}</b></div>
          <div class="kv"><span class="muted">No matcheados</span><br><b>{{ resumen.no_matcheados }}</b></div>
        </div>
      </div>

      <div class="card">
        <h5>Porcentajes</h5>
        {% with
            pm=resumen.matcheados|pct:resumen.total_legajos|clamp:"0,100"
            pn=resumen.no_matcheados|pct:resumen.total_legajos|clamp:"0,100"
        %}
          <div class="small">Matcheados ({{ pm|floatformat:1 }}%)</div>
          <div class="progress">
            <span class="bar bar--ok" style="width: {{ pm|floatformat:1 }}%;"></span>
          </div>

          <div class="small" style="margin-top:8px;">No matcheados ({{ pn|floatformat:1 }}%)</div>
          <div class="progress">
            <span class="bar bar--bad" style="width: {{ pn|floatformat:1 }}%;"></span>
          </div>
        {% endwith %}
      </div>
    </div>

    {% if resumen.detalle_match and resumen.detalle_match|length > 0 %}
      <div class="section">
        <h4>Detalle de aprobado</h4>
        <table>
          <thead>
            <tr>
              <th style="width: 32px;"></th>
              <th>Documento</th>
              <th>Nombre</th>
              <th>Apellido</th>
              <th>Coincidencia por</th>
            </tr>
          </thead>
          <tbody>
            {% for fila in resumen.detalle_match %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ fila.dni|default_if_none:"" }}</td>
                <td>{{ fila.nombre|default_if_none:"" }}</td>
                <td>{{ fila.apellido|default_if_none:"" }}</td>
                <td class="muted">{{ fila.por|default_if_none:"" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
    <div class="page-break"></div>
    <div class="section">
      <h4>Detalle de no aprobado</h4>
      <table>
        <thead>
          <tr>
            <th style="width: 32px;"></th>
            <th>DNI</th>
            <th>CUIT esperado</th>
            <th>Observación</th>
          </tr>
        </thead>
        <tbody>
          {% if resumen.detalle_no_match and resumen.detalle_no_match|length %}
            {% for fila in resumen.detalle_no_match %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ fila.dni|default_if_none:"" }}</td>
                <td>{{ fila.cuit|default_if_none:"" }}</td>
                <td class="muted">
                  {{ fila.observacion|default:"No coincide por CUIT ni por DNI." }}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="4" class="muted">No se registran casos sin match.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <div class="section">
      <h4>Notas</h4>
      <ul>
        <li>Las coincidencias se determinan por CUIT exacto (11 dígitos) o por DNI normalizado (sin ceros a la izquierda).</li>
        <li>En columnas con rótulo “cuit” que contengan valores de 8 dígitos, se interpretan como DNI.</li>
        <li>Regla aplicada: sólo se cruzan legajos con revisión del técnico en estado “APROBADO”.</li>
        <li>En “Observación” puede aparecer “No está en archivo de Syntys” o “No coincide por CUIT/DNI”. Si el legajo fue rechazado por el técnico, no se cruza y no aparece en esta lista.</li>
      </ul>
    </div>
  </main>
</body>
</html>
{% block customJS %}
  <script src="{% static 'custom/js/pdfceliaquia.css' %}"></script>
{% endblock %}