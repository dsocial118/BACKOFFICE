{% load custom_filters %}
<tr id="fila-{{ doc.row_id }}"
    data-personalizado="{{ doc.es_personalizado|yesno:'1,0' }}"
    data-documentacion-id="{{ doc.documentacion_id|default:'' }}"
    data-archivo-id="{{ doc.archivo_id|default:'' }}">
    <td class="ps-3">
        {% if doc.estado_valor == "Rectificar" %}<i class="bi bi-x-circle text-danger fs-4 fw-bold me-1"></i>{% endif %}
        {{ doc.nombre }}
        {% if doc.obligatorio %}<span class="text-danger fs-5 ms-1">*</span>{% endif %}
    </td>
    <td id="estado-{{ doc.archivo_id|default:doc.row_id }}"
        class="ps-1 text-center"
        style="min-width: 8rem">
        {% if doc.estado == "Aceptado" %}
            <span class="badge bg-success">Aceptado</span>
        {% elif doc.estado == "Pendiente" %}
            <span class="badge bg-secondary">Pendiente</span>
        {% elif doc.estado == "A Validar Abogado" %}
            {% if request.user|has_group:"Tecnico Comedor" %}
                <span class="badge bg-primary">A Validar Abogado</span>
            {% elif request.user|has_group:"Abogado Dupla" and doc.archivo_id %}
                <select class="form-control form-control-sm mb-2 border border-2 border-primary"
                        onchange="actualizarEstado(this)"
                        data-admision-id="{{ admision.id }}"
                        data-documento-id="{{ doc.archivo_id }}"
                        data-url="{% url 'actualizar_estado_archivo' %}"
                        data-requires-observacion="1"
                        data-current-value="{{ doc.estado }}">
                    <option value="A Validar Abogado"
                            {% if doc.estado == 'A Validar Abogado' %}selected{% endif %}>A Validar Abogado</option>
                    <option value="Aceptado">Aceptado</option>
                    <option value="Rectificar">Rectificar</option>
                </select>
            {% else %}
                {{ doc.estado }}
            {% endif %}
        {% else %}
            {% if request.user|has_group:"Tecnico Comedor" and doc.archivo_id %}
                <select class="form-control form-control-sm mb-2{% if doc.estado == 'Rectificar' %} border border-danger border-2{% endif %}"
                        onchange="actualizarEstado(this)"
                        data-admision-id="{{ admision.id }}"
                        data-documento-id="{{ doc.archivo_id }}"
                        data-url="{% url 'actualizar_estado_archivo' %}"
                        data-requires-observacion="0"
                        data-current-value="{{ doc.estado_valor }}">
                    {% if doc.estado == 'Rectificar' %}<option value="Rectificar" selected disabled>Rectificar</option>{% endif %}
                    <option value="Documento adjunto"
                            {% if doc.estado_valor == 'Documento adjunto' %}selected disabled{% endif %}>
                        Documento adjunto
                    </option>
                    <option value="A Validar Abogado"
                            {% if doc.estado_valor == 'A Validar Abogado' %}selected{% endif %}>
                        A Validar Abogado
                    </option>
                </select>
            {% else %}
                <span class="badge {% if doc.estado == 'Rectificar' %}bg-danger {% elif doc.estado == 'Aceptado' %}bg-success {% elif doc.estado == 'Pendiente' or doc.estado == 'Documento adjunto' %}bg-secondary {% else %}bg-primary {% endif %}">
                    {{ doc.estado }}
                </span>
            {% endif %}
        {% endif %}
    </td>
    <td>
        {% if doc.archivo_url %}
            <a href="{{ doc.archivo_url }}"
               target="_blank"
               class="btn btn-primary btn-sm">Ver Archivo</a>
            {% if request.user|has_group:"Tecnico Comedor" and admision.estado.nombre != "Finalizada" and admision.estado.nombre != "Descartado" %}
                {% if doc.estado != "Aceptado" and doc.estado != "A Validar Abogado" %}
                    <button class="btn btn-sm btn-danger px-3 ms-2"
                            onclick="confirmarEliminar({{ admision.id }}, {{ doc.documentacion_id|default:'null' }}, {{ doc.archivo_id|default:'null' }})">
                        Eliminar
                    </button>
                {% endif %}
            {% endif %}
        {% else %}
            {% if request.user|has_group:"Tecnico Comedor" and not doc.es_personalizado and not admision.enviada_a_archivo and admision.estado.nombre != "Finalizada" and admision.estado.nombre != "Descartado" %}
                <input type="file"
                       id="file-{{ doc.documentacion_id }}"
                       class="d-none"
                       onchange="subirArchivo({{ admision.id }}, {{ doc.documentacion_id }})" />
                <button type="button"
                        class="btn btn-sm btn-outline-primary"
                        onclick="document.getElementById('file-{{ doc.documentacion_id }}').click()">Adjuntar</button>
                <div class="progress mt-2"
                     id="progress-container-{{ doc.documentacion_id }}"
                     style="display:none;
                            height: 3px">
                    <div class="progress-bar  progress-bar-striped"
                         role="progressbar"
                         id="progress-bar-{{ doc.documentacion_id }}"
                         style="width: 0%">0%</div>
                </div>
            {% endif %}
        {% endif %}
    </td>
    <td id="gde-{{ doc.id }}">
        {% if doc.estado == "Aceptado" %}
            {% if request.user.is_superuser or request.user|has_group:"Tecnico Comedor" %}
                <!-- Modo vista (por defecto) -->
                <div id="gde-display-{{ doc.id }}"
                     class="gde-display"
                     onclick="activarEdicionGDE({{ doc.id }})">
                    {% if doc.numero_gde %}
                        <span class="text-success fw-bold">{{ doc.numero_gde }}</span>
                        <i class="bi bi-pencil-square ms-2 text-muted"
                           style="cursor: pointer"
                           title="Editar número GDE"></i>
                    {% else %}
                        <span class="text-muted">Sin número GDE</span>
                        <i class="bi bi-plus-circle ms-2 text-primary"
                           style="cursor: pointer"
                           title="Agregar número GDE"></i>
                    {% endif %}
                </div>
                <!-- Modo edición (oculto por defecto) -->
                <div id="gde-edit-{{ doc.id }}" class="gde-edit d-none">
                    <div class="d-flex align-items-center">
                        <input type="text"
                               class="form-control form-control-sm me-2"
                               id="gde-input-{{ doc.id }}"
                               value="{{ doc.numero_gde|default_if_none:'' }}"
                               placeholder="Ingrese número GDE"
                               maxlength="50"
                               style="max-width: 150px" />
                        <button class="btn btn-success btn-sm me-1"
                                onclick="guardarNumeroGDE({{ doc.id }})"
                                title="Guardar">
                            <i class="bi bi-check"></i>
                        </button>
                        <button class="btn btn-secondary btn-sm"
                                onclick="cancelarEdicionGDE({{ doc.id }})"
                                title="Cancelar">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>
            {% else %}
                {% if doc.numero_gde %}
                    <span class="text-success fw-bold">{{ doc.numero_gde }}</span>
                {% else %}
                    <span class="text-muted">-</span>
                {% endif %}
            {% endif %}
        {% else %}
            {% if doc.numero_gde %}
                <span class="text-success fw-bold">{{ doc.numero_gde }}</span>
            {% else %}
                <span class="text-muted">-</span>
            {% endif %}
        {% endif %}
    </td>
</tr>
{% if doc.observaciones %}
    <tr id="fila-obs-{{ doc.archivo_id|default:doc.row_id }}"
        class="{% if doc.estado != 'Rectificar' %}d-none{% endif %}">
        <td colspan="4" class="bg-danger-subtle small ps-4">
            <strong><i class="bi bi-arrow-return-right fs-6"></i> Observaciones:</strong>
            <span>{{ doc.observaciones|linebreaksbr }}</span>
        </td>
    </tr>
{% endif %}
